<h1>Remote Host: <%= @ip %></h1>

<% require "cgi" %>

<div class="netmon-detail">
  <div class="item"><strong>First Seen:</strong> <%= @first_seen || "--" %></div>
  <div class="item"><strong>Last Seen:</strong> <%= @last_seen || "--" %></div>
  <div class="item"><strong>Ports:</strong> <%= @ports.any? ? @ports.join(", ") : "--" %></div>
  <div class="item"><strong>Total Traffic:</strong> <%= @traffic.to_i %> bytes</div>
  <div class="item"><strong>rDNS:</strong> <span id="copy-rdns"><%= @rdns || "--" %></span>
    <button type="button" class="copy-btn" data-copy="copy-rdns">Copy</button>
  </div>
  <div class="item"><strong>WHOIS:</strong> <span id="copy-org" title="<%= @whois_raw.to_s %>"><%= @whois || "--" %></span>
    <button type="button" class="copy-btn" data-copy="copy-org">Copy</button>
  </div>
  <div class="item"><strong>ASN:</strong> <span id="copy-asn"><%= @host&.whois_asn || "--" %></span>
    <button type="button" class="copy-btn" data-copy="copy-asn">Copy</button>
  </div>
  <div class="item"><strong>IP:</strong> <span id="copy-ip"><%= @ip %></span>
    <button type="button" class="copy-btn" data-copy="copy-ip">Copy</button>
  </div>
  <div class="item"><strong>Geo:</strong> <%= @geo || "--" %></div>
</div>

<div class="netmon-detail">
  <%= form_with url: "/remote_hosts/#{@ip}", method: :patch, local: true do |form| %>
    <label>
      Tag
      <%= form.select :tag, [["Unknown", "unknown"], ["Known Good", "known_good"], ["Suspicious", "suspicious"]], selected: @host&.tag %>
    </label>
    <label>
      Notes
      <%= form.text_area :notes, value: @host&.notes, rows: 3, cols: 60 %>
    </label>
    <%= form.submit "Save" %>
  <% end %>
</div>

<div class="netmon-detail">
  <% if @host&.whois_asn.present? %>
    <a href="/search/hosts?whois_asn=<%= CGI.escape(@host.whois_asn) %>">Show all hosts in same ASN</a>
  <% end %>
  <% if @rdns.to_s.include?(".") %>
    <% suffix = @rdns.to_s.split(".").last(2).join(".") %>
    <a href="/search/hosts?rdns=<%= CGI.escape(suffix) %>">Show all hosts with same rDNS suffix</a>
  <% end %>
</div>

<div class="netmon-detail">
  <div class="item"><strong>Block Rule (display only):</strong></div>
  <pre>add rule inet filter output ip daddr <%= @ip %> drop</pre>
</div>

<div class="netmon-detail">
  <% if @host&.whois_asn.present? %>
    <%= form_with url: "/allowlist_rules", method: :post, local: true do |form| %>
      <input type="hidden" name="allowlist_rule[kind]" value="asn">
      <input type="hidden" name="allowlist_rule[value]" value="<%= @host.whois_asn %>">
      <button type="submit">Allowlist this ASN</button>
    <% end %>
  <% end %>

  <% if @host&.whois_name.present? %>
    <%= form_with url: "/allowlist_rules", method: :post, local: true do |form| %>
      <input type="hidden" name="allowlist_rule[kind]" value="org">
      <input type="hidden" name="allowlist_rule[value]" value="<%= @host.whois_name %>">
      <button type="submit">Allowlist this org</button>
    <% end %>
    <%= form_with url: "/suppression_rules", method: :post, local: true do |form| %>
      <input type="hidden" name="suppression_rule[code]" value="NO_RDNS">
      <input type="hidden" name="suppression_rule[kind]" value="org">
      <input type="hidden" name="suppression_rule[value]" value="<%= @host.whois_name %>">
      <button type="submit">Suppress NO_RDNS for this org</button>
    <% end %>
  <% end %>
</div>

<h2>Port History</h2>
<table class="netmon-table">
  <thead>
    <tr>
      <th>Port</th>
      <th>First Seen</th>
      <th>Last Seen</th>
      <th>Seen Count</th>
    </tr>
  </thead>
  <tbody>
    <% @port_history.each do |row| %>
      <tr>
        <td><%= row.dst_port %></td>
        <td><%= row.first_seen_at %></td>
        <td><%= row.last_seen_at %></td>
        <td><%= row.seen_count %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<div class="netmon-detail">
  <button type="button" id="traceroute-run">Run Traceroute</button>
  <button type="button" id="traceroute-cancel" disabled>Cancel</button>
  <span id="traceroute-status"></span>
  <span id="traceroute-timeout"></span>
  <pre id="traceroute-output" style="display: none;"></pre>
</div>

<script>
  (function() {
    const runButton = document.getElementById("traceroute-run");
    const statusEl = document.getElementById("traceroute-status");
    const cancelButton = document.getElementById("traceroute-cancel");
    const timeoutEl = document.getElementById("traceroute-timeout");
    const outputEl = document.getElementById("traceroute-output");
    if (!runButton) return;

    const url = "/remote_hosts/<%= @ip %>/traceroute.json";
    let startTime = null;
    const timeoutMs = 15000;

    function poll() {
      fetch(url)
        .then((resp) => resp.json())
        .then((data) => {
          statusEl.textContent = data.status;
          if (data.status === "done" || data.status === "error") {
            outputEl.style.display = "block";
            outputEl.textContent = data.output || "";
            cancelButton.disabled = true;
            return;
          }
          if (startTime && Date.now() - startTime > timeoutMs) {
            timeoutEl.textContent = "Timed out";
            cancelButton.disabled = true;
            return;
          }
          setTimeout(poll, 1500);
        })
        .catch(() => {});
    }

    runButton.addEventListener("click", () => {
      statusEl.textContent = "queued";
      timeoutEl.textContent = "";
      startTime = Date.now();
      outputEl.style.display = "none";
      cancelButton.disabled = false;
      fetch(`${url}?start=1`)
        .then(() => poll())
        .catch(() => {});
    });

    cancelButton.addEventListener("click", () => {
      cancelButton.disabled = true;
      timeoutEl.textContent = "Cancelled";
      fetch(`${url}?cancel=1`).catch(() => {});
    });
  })();
</script>

<h2>Connections</h2>
<table class="netmon-table">
  <thead>
    <tr>
      <th>Proto</th>
      <th>Source</th>
      <th>Port</th>
      <th>State</th>
      <th>Up</th>
      <th>Down</th>
      <th>Total</th>
      <th>Last Seen</th>
    </tr>
  </thead>
  <tbody>
    <% @connections.each do |conn| %>
      <tr>
        <td><%= conn.proto %></td>
        <td><a href="/search/connections?device=<%= CGI.escape(conn.src_ip) %>&dst_ip=<%= CGI.escape(@ip) %>"><%= conn.src_ip %></a></td>
        <td><%= conn.dst_port %></td>
        <td><%= conn.state %></td>
        <td><%= conn.uplink_bytes %></td>
        <td><%= conn.downlink_bytes %></td>
        <td><%= conn.uplink_bytes + conn.downlink_bytes %></td>
        <td><%= conn.last_seen_at %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<script>
  (function() {
    document.querySelectorAll(".copy-btn").forEach((button) => {
      button.addEventListener("click", () => {
        const targetId = button.dataset.copy;
        const el = document.getElementById(targetId);
        if (!el) return;
        const text = el.textContent.trim();
        if (text === "--" || text === "") return;
        navigator.clipboard?.writeText(text);
      });
    });
  })();
</script>
