<% input_class = "bg-black border border-zinc-800 rounded-lg px-2 py-1.5 text-zinc-200 placeholder:text-zinc-600 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black" %>
<% checkbox_class = "rounded border-zinc-700 bg-black text-cyan-400 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black" %>
<% button_primary = "bg-emerald-600/20 text-emerald-200 border border-emerald-700/40 hover:bg-emerald-600/30 rounded-lg px-3 py-1 text-sm" %>
<% button_secondary = "bg-cyan-600/15 text-cyan-200 border border-cyan-700/40 hover:bg-cyan-600/25 rounded-lg px-3 py-1 text-sm" %>
<% button_neutral = "bg-zinc-900/50 text-zinc-200 border border-zinc-800 hover:bg-zinc-900/80 rounded-lg px-3 py-1 text-sm" %>

<h1 class="text-xl text-emerald-300 font-semibold tracking-wide mb-3">Active Connections</h1>

<form method="get" class="mb-4" id="connections-filter">
  <%= render "shared/filter_bar", storage_key: "netmon.filterbar.dashboard" do %>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Src IP
      <input class="<%= input_class %>" name="src_ip" value="<%= params[:src_ip].to_s %>">
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Dst IP
      <input class="<%= input_class %>" name="dst_ip" value="<%= params[:dst_ip].to_s %>">
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Dst Port
      <input class="<%= input_class %>" name="dport" value="<%= params[:dport].to_s %>">
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Proto
      <input class="<%= input_class %>" name="proto" value="<%= params[:proto].to_s %>">
    </label>
    <label class="flex items-center gap-2 text-xs uppercase tracking-wider text-zinc-400 mt-4">
      <input type="checkbox" class="<%= checkbox_class %>" name="hide_time_wait" value="true" <%= "checked" if params[:hide_time_wait].present? %>>
      Hide TIME_WAIT
    </label>
    <label class="flex items-center gap-2 text-xs uppercase tracking-wider text-zinc-400 mt-4">
      <input type="checkbox" class="<%= checkbox_class %>" name="only_new" value="true" <%= "checked" if params[:only_new].present? %>>
      Only NEW
    </label>
    <label class="flex items-center gap-2 text-xs uppercase tracking-wider text-zinc-400 mt-4">
      <input type="checkbox" class="<%= checkbox_class %>" name="include_stale" value="true" <%= "checked" if params[:include_stale].present? %>>
      Include stale
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Min Score
      <select class="<%= input_class %>" name="min_score">
        <option value="" <%= "selected" if params[:min_score].to_s.empty? %>>All</option>
        <option value="0" <%= "selected" if params[:min_score] == "0" %>>0</option>
        <option value="20" <%= "selected" if params[:min_score] == "20" %>>20</option>
        <option value="50" <%= "selected" if params[:min_score] == "50" %>>50</option>
      </select>
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Interfaces
      <input id="metric-interfaces" class="<%= input_class %>" name="interfaces" value="<%= params[:interfaces].to_s %>" list="interface-options">
      <datalist id="interface-options">
        <option value="enp42s0"></option>
        <option value="enp2s0"></option>
        <option value="enp3s0"></option>
      </datalist>
    </label>
    <input type="hidden" name="sort" value="<%= params[:sort].to_s %>">
    <input type="hidden" name="dir" value="<%= params[:dir].to_s %>">
    <div class="flex flex-wrap items-center gap-2 ml-auto">
      <button type="submit" class="<%= button_primary %>">Apply</button>
      <a href="/" class="<%= button_neutral %>">Clear</a>
      <a href="?only_new=true" class="<%= button_secondary %>">Only NEW</a>
      <a href="?hide_time_wait=true" class="<%= button_secondary %>">Hide TIME_WAIT</a>
      <a href="?min_score=0" class="<%= button_neutral %>">Score 0+</a>
      <a href="?min_score=20" class="<%= button_neutral %>">Score 20+</a>
      <a href="?min_score=50" class="<%= button_neutral %>">Score 50+</a>
    </div>
  <% end %>
</form>

<section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-6 gap-3 mb-4">
  <%= render "shared/card" do %>
    <%= render "shared/stat", label: "Load Avg", value: "<span id='metric-loadavg'>--</span>".html_safe %>
  <% end %>
  <%= render "shared/card" do %>
  <%= render "shared/stat", label: "Collector", value: "<span id='metric-collector'>--</span>".html_safe, value_class: "text-emerald-300" %>
  <% end %>
  <%= render "shared/card" do %>
    <%= render "shared/stat", label: "Memory", value: "<span id='metric-mem'>--</span>".html_safe %>
  <% end %>
  <%= render "shared/card" do %>
    <%= render "shared/stat", label: "Interfaces", value: "<span id='metric-ifaces'>--</span>".html_safe %>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-1">
      <div class="text-xs uppercase tracking-wider text-zinc-500">New DST IPs</div>
      <select class="stat-window <%= input_class %> text-xs" data-series="new_dst_ips_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <button type="button" id="metric-new-dst" class="text-cyan-200 hover:text-cyan-100 text-lg">--</button>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-1">
      <div class="text-xs uppercase tracking-wider text-zinc-500">Unique DPorts</div>
      <select class="stat-window <%= input_class %> text-xs" data-series="unique_dports_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <button type="button" id="metric-unique-dports" class="text-cyan-200 hover:text-cyan-100 text-lg">--</button>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-1">
      <div class="text-xs uppercase tracking-wider text-zinc-500">Uplink Bytes</div>
      <select class="stat-window <%= input_class %> text-xs" data-series="uplink_bytes_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <button type="button" id="metric-uplink-bytes" class="text-cyan-200 hover:text-cyan-100 text-lg">--</button>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-1">
      <div class="text-xs uppercase tracking-wider text-zinc-500">New ASNs</div>
      <select class="stat-window <%= input_class %> text-xs" data-series="new_asns_last_1h">
        <option value="10m">10m</option>
        <option value="1h" selected>1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <button type="button" id="metric-new-asns" class="text-cyan-200 hover:text-cyan-100 text-lg">--</button>
  <% end %>
</section>

<section class="grid grid-cols-1 lg:grid-cols-4 gap-3 mb-4">
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <div>
        <h3 class="text-xs uppercase tracking-wider text-zinc-500">Load Avg (1m)</h3>
        <div class="text-xs text-zinc-500" data-range-label="graph-loadavg1">Last 10m</div>
      </div>
      <select class="system-window <%= input_class %> text-xs" data-metric="loadavg1">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-loadavg1" data-metric="loadavg1" class="w-full h-32"></canvas>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <div>
        <h3 class="text-xs uppercase tracking-wider text-zinc-500">Disk Read Bytes</h3>
        <div class="text-xs text-zinc-500" data-range-label="graph-disk-read">Last 10m</div>
      </div>
      <select class="system-window <%= input_class %> text-xs" data-metric="disk_read_bytes">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-disk-read" data-metric="disk_read_bytes" class="w-full h-32"></canvas>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <div>
        <h3 class="text-xs uppercase tracking-wider text-zinc-500">Disk Write Bytes</h3>
        <div class="text-xs text-zinc-500" data-range-label="graph-disk-write">Last 10m</div>
      </div>
      <select class="system-window <%= input_class %> text-xs" data-metric="disk_write_bytes">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-disk-write" data-metric="disk_write_bytes" class="w-full h-32"></canvas>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <div>
        <h3 class="text-xs uppercase tracking-wider text-zinc-500">New DST IPs</h3>
        <div class="text-xs text-zinc-500" data-range-label="graph-new-dst">Last 10m</div>
      </div>
      <select class="graph-window <%= input_class %> text-xs" data-series="new_dst_ips_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-new-dst" data-series="new_dst_ips_last_10m" class="w-full h-32"></canvas>
  <% end %>
</section>

<div class="text-xs text-zinc-500 mb-4">Updated: <span id="metrics-updated">--</span></div>

<section id="metric-detail" class="hidden mb-4">
  <%= render "shared/card" do %>
    <div class="text-xs uppercase tracking-wider text-zinc-500 mb-2" id="metric-detail-title"></div>
    <div id="metric-detail-body" class="text-sm text-zinc-200"></div>
  <% end %>
</section>

<div id="drilldown-overlay" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/70 drilldown-backdrop"></div>
  <div class="relative ml-auto h-full w-full max-w-2xl bg-zinc-950 border-l border-emerald-900/50 p-4 overflow-y-auto">
    <div class="flex items-center justify-between gap-3 mb-3">
      <div>
        <div class="text-xs uppercase tracking-wider text-zinc-500" id="drilldown-window">Window</div>
        <h2 class="text-lg text-emerald-200 font-semibold" id="drilldown-title">Drilldown</h2>
        <div class="text-xs text-zinc-500" id="drilldown-generated">Generated: --</div>
      </div>
      <button type="button" id="drilldown-close" class="bg-zinc-900/60 text-zinc-200 border border-zinc-800 hover:bg-zinc-900/80 rounded-lg px-3 py-1 text-sm">Close</button>
    </div>
    <div id="drilldown-warning" class="hidden text-xs text-amber-200 mb-3">Limited to 200 rows.</div>
    <div class="flex flex-wrap items-center gap-2 mb-3">
      <button type="button" id="drilldown-copy-ports" class="bg-cyan-600/15 text-cyan-200 border border-cyan-700/40 hover:bg-cyan-600/25 rounded-lg px-3 py-1 text-sm hidden">Copy Ports</button>
      <button type="button" id="drilldown-copy-ips" class="bg-cyan-600/15 text-cyan-200 border border-cyan-700/40 hover:bg-cyan-600/25 rounded-lg px-3 py-1 text-sm hidden">Copy IPs</button>
    </div>
    <div class="flex items-center gap-2 mb-3 text-sm text-zinc-400" id="drilldown-pagination">
      <button type="button" id="drilldown-prev" class="bg-zinc-900/60 text-zinc-200 border border-zinc-800 hover:bg-zinc-900/80 rounded-lg px-3 py-1 text-sm" disabled>Prev</button>
      <span id="drilldown-page">Page 1</span>
      <button type="button" id="drilldown-next" class="bg-zinc-900/60 text-zinc-200 border border-zinc-800 hover:bg-zinc-900/80 rounded-lg px-3 py-1 text-sm" disabled>Next</button>
    </div>
    <div id="drilldown-body" class="space-y-2"></div>
  </div>
</div>

<div id="chart-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/70 chart-backdrop"></div>
  <div class="relative mx-auto mt-12 w-[90vw] max-w-4xl bg-zinc-950 border border-emerald-900/50 rounded-2xl p-4">
    <div class="flex items-center justify-between gap-3 mb-3">
      <div class="text-sm text-emerald-200 font-semibold" id="chart-modal-title">Chart</div>
      <button type="button" id="chart-modal-close" class="bg-zinc-900/60 text-zinc-200 border border-zinc-800 hover:bg-zinc-900/80 rounded-lg px-3 py-1 text-sm">Close</button>
    </div>
    <canvas id="chart-modal-canvas" class="w-full h-80"></canvas>
  </div>
</div>

<section class="grid grid-cols-1 lg:grid-cols-4 gap-3 mb-4">
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <div>
        <h3 class="text-xs uppercase tracking-wider text-zinc-500">Uplink Bytes</h3>
        <div class="text-xs text-zinc-500" data-range-label="graph-uplink-bytes">Last 10m</div>
      </div>
      <select class="graph-window <%= input_class %> text-xs" data-series="uplink_bytes_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-uplink-bytes" data-series="uplink_bytes_last_10m" class="w-full h-32"></canvas>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <div>
        <h3 class="text-xs uppercase tracking-wider text-zinc-500">Download Bytes</h3>
        <div class="text-xs text-zinc-500" data-range-label="graph-download">Last 10m</div>
      </div>
      <select class="system-window <%= input_class %> text-xs" data-metric="rx_bytes">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-download" data-metric="rx_bytes" class="w-full h-32"></canvas>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <div>
        <h3 class="text-xs uppercase tracking-wider text-zinc-500">Unique DPorts</h3>
        <div class="text-xs text-zinc-500" data-range-label="graph-unique-dports">Last 10m</div>
      </div>
      <select class="graph-window <%= input_class %> text-xs" data-series="unique_dports_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-unique-dports" data-series="unique_dports_last_10m" class="w-full h-32"></canvas>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <div>
        <h3 class="text-xs uppercase tracking-wider text-zinc-500">New ASNs</h3>
        <div class="text-xs text-zinc-500" data-range-label="graph-new-asns">Last 1h</div>
      </div>
      <select class="graph-window <%= input_class %> text-xs" data-series="new_asns_last_1h">
        <option value="10m">10m</option>
        <option value="1h" selected>1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-new-asns" data-series="new_asns_last_1h" class="w-full h-32"></canvas>
  <% end %>
</section>

<%= render "shared/card" do %>
  <div class="flex items-center justify-between gap-3">
    <div class="text-xs uppercase tracking-wider text-zinc-500">Anomalies</div>
    <div id="metric-anomalies" class="text-sm text-amber-200">None</div>
  </div>
<% end %>

<div class="mt-4">
  <%= render "shared/card" do %>
    <div class="text-xs uppercase tracking-wider text-zinc-500 mb-2">Recent Incidents (1h)</div>
    <ol id="panel-recent-incidents" class="space-y-1 text-sm leading-5"></ol>
  <% end %>
</div>

<section class="grid grid-cols-1 lg:grid-cols-4 gap-3 mt-4 mb-4">
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">Top Remote Hosts (10m)</h3>
      <select class="panel-window <%= input_class %> text-xs" data-panel="top-remote" data-default="10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <ol id="panel-top-remote-hosts" class="space-y-1 text-sm">
      <% @top_remote_hosts.each do |row| %>
        <% total_bytes = row[:total_bytes].to_i %>
        <li><a href="/remote_hosts/<%= row[:ip] %>"><%= row[:ip] %></a> (<span title="<%= total_bytes %>"><%= format_bytes(total_bytes) %></span>)</li>
      <% end %>
    </ol>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">Newest Remote Hosts (10m)</h3>
      <a id="panel-newest-viewall" class="text-xs text-cyan-200 hover:text-cyan-100" href="/remote_hosts?window=10m">View All</a>
    </div>
    <select class="panel-window <%= input_class %> text-xs mb-2" data-panel="newest" data-default="10m">
      <option value="10m" selected>10m</option>
      <option value="1h">1h</option>
      <option value="24h">24h</option>
      <option value="1w">1w</option>
    </select>
    <ol id="panel-newest-remote-hosts" class="space-y-1 text-sm">
      <% @newest_remote_hosts.each do |host| %>
        <li><a href="/remote_hosts/<%= host[:ip] %>"><%= host[:ip] %><%= host[:port] ? ":#{host[:port]}" : "" %></a></li>
      <% end %>
    </ol>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">Rare Ports (24h)</h3>
      <select class="panel-window <%= input_class %> text-xs" data-panel="rare" data-default="24h">
        <option value="10m">10m</option>
        <option value="1h">1h</option>
        <option value="24h" selected>24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <ol id="panel-rare-ports" class="space-y-1 text-sm">
      <li><button type="button" class="rare-port-item text-cyan-200 hover:text-cyan-100 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black rounded" data-port="all">View All</button></li>
      <% @rare_ports.each do |row| %>
        <% ip_snippet = row[:ips].to_a.first(2).join(", ") %>
        <% suffix = ip_snippet.present? ? " — #{ip_snippet}" : "" %>
        <li><button type="button" class="rare-port-item text-cyan-200 hover:text-cyan-100 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black rounded" data-port="<%= row[:port] %>"><%= row[:port] %> (<%= row[:count] %>)<%= suffix %></button></li>
      <% end %>
    </ol>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">Devices by Egress (10m)</h3>
      <select class="panel-window <%= input_class %> text-xs" data-panel="devices-egress" data-default="10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <ol id="panel-top-devices-egress" class="space-y-1 text-sm">
      <% @top_devices_egress.each do |row| %>
        <% total_uplink = row[:total_uplink].to_i %>
        <li><%= row[:label] %> (<span title="<%= total_uplink %>"><%= format_bytes(total_uplink) %></span>)</li>
      <% end %>
    </ol>
  <% end %>
</section>

<div class="flex items-center justify-between mb-2">
  <details class="relative">
    <summary class="cursor-pointer text-sm text-cyan-200 hover:text-cyan-100">Columns</summary>
    <div class="absolute z-10 mt-2 w-56 rounded-xl border border-zinc-800/80 bg-zinc-950/90 p-3 shadow-[0_0_0_1px_rgba(16,185,129,0.10)]">
      <div class="text-xs uppercase tracking-wider text-zinc-500 mb-2">Toggle Columns</div>
      <div id="columns-toggle" class="space-y-1 text-sm"></div>
    </div>
  </details>
</div>

<%= render "shared/table" do %>
  <thead class="bg-zinc-950 text-zinc-400 text-xs uppercase tracking-wider">
    <tr>
      <th class="px-2 py-1.5 text-left" data-col="proto">Proto</th>
      <th class="px-2 py-1.5 text-left" data-col="device">Device</th>
      <th class="px-2 py-1.5 text-left" data-col="source">Source</th>
      <th class="px-2 py-1.5 text-left" data-col="destination"><%= sortable_th("Dst IP", "dst_ip") %></th>
      <th class="px-2 py-1.5 text-left" data-col="state">State</th>
      <th class="px-2 py-1.5 text-left" data-col="flags">Flags</th>
      <th class="px-2 py-1.5 text-right" data-col="up"><%= sortable_th("Up", "uplink_bytes") %></th>
      <th class="px-2 py-1.5 text-right" data-col="down"><%= sortable_th("Down", "downlink_bytes") %></th>
      <th class="px-2 py-1.5 text-right" data-col="total"><%= sortable_th("Total", "total_bytes") %></th>
      <th class="px-2 py-1.5 text-left" data-col="score"><%= sortable_th("Score", "score") %></th>
      <th class="px-2 py-1.5 text-left" data-col="reasons">Reasons</th>
      <th class="px-2 py-1.5 text-left" data-col="allow">Allow</th>
      <th class="px-2 py-1.5 text-left" data-col="age"><%= sortable_th("Age", "age") %></th>
      <th class="px-2 py-1.5 text-left" data-col="rdns">rDNS</th>
      <th class="px-2 py-1.5 text-left" data-col="whois">WHOIS</th>
      <th class="px-2 py-1.5 text-left" data-col="seen">Seen</th>
    </tr>
  </thead>
  <tbody id="connections-body">
    <% @connections.each do |conn| %>
      <% host = @hosts_by_ip[conn.dst_ip] %>
      <% device = @devices_by_ip[conn.src_ip] %>
      <% seen_label = host&.new? ? "NEW" : "SEEN" %>
      <% seen_age = host&.seen_age || "unknown" %>
      <% device_label = device&.name.presence || conn.src_ip %>
      <% reasons = begin
           JSON.parse(conn.anomaly_reasons_json || "[]")
         rescue JSON::ParserError
           []
         end %>
      <% reason_codes = reasons.map { |reason| reason["code"] }.compact %>
      <% score = conn.anomaly_score.to_i %>
      <% score_badge = score >= 70 ? "alert" : (score >= 50 ? "warn" : (score >= 20 ? "info" : "neutral")) %>
      <tr class="odd:bg-black even:bg-zinc-950/30 hover:bg-zinc-900/50">
        <td class="px-2 py-1.5 font-mono text-xs" data-col="proto"><%= conn.proto %></td>
        <td class="px-2 py-1.5" data-col="device">
          <% if device %>
            <input class="device-name-input <%= input_class %> text-xs" data-device-id="<%= device.id %>" value="<%= device.name %>" size="12">
          <% else %>
            <%= device_label %>
          <% end %>
        </td>
        <td class="px-2 py-1.5" data-col="source"><a href="/remote_hosts/<%= conn.src_ip %>"><%= conn.src_ip %></a>:<%= conn.src_port %></td>
        <td class="px-2 py-1.5" data-col="destination">
          <a href="/remote_hosts/<%= conn.dst_ip %>"><%= conn.dst_ip %></a><%= conn.dst_port ? ":#{conn.dst_port}" : "" %>
        </td>
        <td class="px-2 py-1.5 font-mono text-xs" data-col="state"><%= conn.state %></td>
        <td class="px-2 py-1.5 font-mono text-xs" data-col="flags"><%= conn.flags %></td>
        <td class="px-2 py-1.5 text-right" data-col="up" title="<%= conn.uplink_bytes %>"><%= format_bytes(conn.uplink_bytes) %></td>
        <td class="px-2 py-1.5 text-right" data-col="down" title="<%= conn.downlink_bytes %>"><%= format_bytes(conn.downlink_bytes) %></td>
        <% total_bytes = conn.uplink_bytes + conn.downlink_bytes %>
        <td class="px-2 py-1.5 text-right" data-col="total" title="<%= total_bytes %>"><%= format_bytes(total_bytes) %></td>
        <td class="px-2 py-1.5" data-col="score"><%= render "shared/badge", text: score, variant: score_badge %></td>
        <td class="px-2 py-1.5 max-w-[260px] truncate" data-col="reasons" title="<%= reason_codes.join(",") %>"><%= reason_codes.join(",") %></td>
        <td class="px-2 py-1.5" data-col="allow">
          <% if device && conn.dst_port %>
            <%= form_with url: "/allowlist_rules", method: :post, local: true do |form| %>
              <input type="hidden" name="allowlist_rule[kind]" value="device_port">
              <input type="hidden" name="allowlist_rule[value]" value="<%= conn.dst_port %>">
              <input type="hidden" name="allowlist_rule[device_id]" value="<%= device.id %>">
              <button type="submit" class="<%= button_secondary %>">Allow port</button>
            <% end %>
          <% end %>
        </td>
        <td class="px-2 py-1.5" data-col="age"><%= seen_age %></td>
        <td class="px-2 py-1.5 max-w-[260px] truncate" data-col="rdns" title="<%= host&.rdns_name.to_s %>"><%= host&.rdns_name || "--" %></td>
        <td class="px-2 py-1.5 max-w-[260px] truncate" data-col="whois" title="<%= host&.try(:whois_raw_line).to_s %>"><%= host&.whois_name || "--" %></td>
        <td class="px-2 py-1.5" data-col="seen">
          <% if seen_label == "NEW" %>
            <%= render "shared/badge", text: "NEW", variant: "info" %>
          <% else %>
            <%= render "shared/badge", text: "SEEN", variant: "neutral" %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
<% end %>

<div class="flex flex-wrap items-center justify-between gap-3 text-xs text-zinc-400 mt-2">
  <div id="connections-page-info">Page 1</div>
  <div class="flex items-center gap-2">
    <button id="connections-prev" class="netmon-button" type="button">Prev</button>
    <button id="connections-next" class="netmon-button" type="button">Next</button>
  </div>
  <div class="flex items-center gap-2">
    <label class="text-[10px] uppercase text-zinc-400" for="connections-per-page">Per page</label>
    <select id="connections-per-page" class="netmon-input">
      <option value="100">100</option>
      <option value="200" selected>200</option>
      <option value="500">500</option>
      <option value="1000">1000</option>
    </select>
  </div>
</div>

<script>
  (function() {
    const body = document.getElementById("connections-body");
    if (!body) return;
    const pageInfoEl = document.getElementById("connections-page-info");
    const prevBtn = document.getElementById("connections-prev");
    const nextBtn = document.getElementById("connections-next");
    const perPageSelect = document.getElementById("connections-per-page");
    const perPageStorageKey = "netmon.connections.per_page";
    let currentPage = 1;
    let totalRows = 0;

    function formatBytes(value) {
      if (value == null) return "--";
      const units = ["B", "KiB", "MiB", "GiB", "TiB"];
      let n = Number(value);
      let idx = 0;
      while (n >= 1024 && idx < units.length - 1) {
        n /= 1024;
        idx += 1;
      }
      const formatted = idx === 0 ? `${Math.round(n)} ${units[idx]}` : `${n.toFixed(1)} ${units[idx]}`;
      return formatted;
    }

    function renderRow(conn) {
      const hideState = enabledColumns.length > 0 && !enabledColumns.includes("state") ? " hidden" : "";
      const hideFlags = enabledColumns.length > 0 && !enabledColumns.includes("flags") ? " hidden" : "";
      const src = conn.src_port
        ? `<a href="/remote_hosts/${conn.src_ip}">${conn.src_ip}</a>:${conn.src_port}`
        : `<a href="/remote_hosts/${conn.src_ip}">${conn.src_ip}</a>`;
      const dst = conn.dst_port
        ? `<a href="/remote_hosts/${conn.dst_ip}">${conn.dst_ip}</a>:${conn.dst_port}`
        : `<a href="/remote_hosts/${conn.dst_ip}">${conn.dst_ip}</a>`;
      const seenLabel = conn.is_new ? "NEW" : "SEEN";
      const score = Number(conn.anomaly_score || 0);
      const scoreVariant = score >= 70 ? "alert" : (score >= 50 ? "warn" : (score >= 20 ? "info" : "neutral"));
      const scoreClass = scoreVariant === "alert"
        ? "bg-red-950/30 text-red-200 border border-red-800/40"
        : (scoreVariant === "warn"
          ? "bg-amber-950/30 text-amber-200 border border-amber-800/40"
          : (scoreVariant === "info"
            ? "bg-cyan-950/30 text-cyan-200 border border-cyan-800/40"
            : "bg-zinc-900/60 text-zinc-200 border border-zinc-700"));
      const reasons = (conn.anomaly_reasons || []).join(",");
      const allowButton = (conn.device_id && conn.dst_port)
        ? `<button type="button" class="allow-port-btn bg-cyan-600/15 text-cyan-200 border border-cyan-700/40 hover:bg-cyan-600/25 rounded-lg px-2 py-0.5 text-xs" data-device-id="${conn.device_id}" data-port="${conn.dst_port}">Allow port</button>`
        : "";
      const deviceCell = conn.device_id
        ? `<input class="device-name-input bg-black border border-zinc-800 rounded-lg px-2 py-1 text-zinc-200 placeholder:text-zinc-600 text-xs" data-device-id="${conn.device_id}" value="${conn.device_name || ""}" size="12">`
        : `<span>${conn.device_name || conn.src_ip}</span>`;
      const seenBadge = seenLabel === "NEW"
        ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-cyan-950/30 text-cyan-200 border border-cyan-800/40">NEW</span>`
        : `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-zinc-900/60 text-zinc-200 border border-zinc-700">SEEN</span>`;
      const up = formatBytes(conn.uplink_bytes);
      const down = formatBytes(conn.downlink_bytes);
      const total = formatBytes(conn.total_bytes);
      return `
        <tr class="odd:bg-black even:bg-zinc-950/30 hover:bg-zinc-900/50">
          <td class="px-2 py-1.5 font-mono text-xs" data-col="proto">${conn.proto}</td>
          <td class="px-2 py-1.5" data-col="device">${deviceCell}</td>
          <td class="px-2 py-1.5" data-col="source">${src}</td>
          <td class="px-2 py-1.5" data-col="destination">${dst}</td>
          <td class="px-2 py-1.5 font-mono text-xs${hideState}" data-col="state">${conn.state || ""}</td>
          <td class="px-2 py-1.5 font-mono text-xs${hideFlags}" data-col="flags">${conn.flags || ""}</td>
          <td class="px-2 py-1.5 text-right" data-col="up" title="${conn.uplink_bytes}">${up}</td>
          <td class="px-2 py-1.5 text-right" data-col="down" title="${conn.downlink_bytes}">${down}</td>
          <td class="px-2 py-1.5 text-right" data-col="total" title="${conn.total_bytes}">${total}</td>
          <td class="px-2 py-1.5" data-col="score"><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ${scoreClass}">${score}</span></td>
          <td class="px-2 py-1.5 max-w-[260px] truncate" data-col="reasons" title="${reasons}">${reasons}</td>
          <td class="px-2 py-1.5" data-col="allow">${allowButton}</td>
          <td class="px-2 py-1.5" data-col="age">${conn.seen_age || "unknown"}</td>
          <td class="px-2 py-1.5 max-w-[260px] truncate" data-col="rdns" title="${conn.rdns_name || ""}">${conn.rdns_name || "--"}</td>
          <td class="px-2 py-1.5 max-w-[260px] truncate" data-col="whois" title="${conn.whois_raw_line || ""}">${conn.whois_name || "--"}</td>
          <td class="px-2 py-1.5" data-col="seen">${seenBadge}</td>
        </tr>
      `;
    }

    function buildConnectionsQuery() {
      const params = new URLSearchParams();
      const form = document.getElementById("connections-filter");
      if (!form) return "";
      const src = form.querySelector("input[name='src_ip']")?.value.trim();
      const dst = form.querySelector("input[name='dst_ip']")?.value.trim();
      const dport = form.querySelector("input[name='dport']")?.value.trim();
      const proto = form.querySelector("input[name='proto']")?.value.trim();
      const hide = form.querySelector("input[name='hide_time_wait']")?.checked;
      const onlyNew = form.querySelector("input[name='only_new']")?.checked;
      const includeStale = form.querySelector("input[name='include_stale']")?.checked;
      const minScore = form.querySelector("select[name='min_score']")?.value;
      const sort = form.querySelector("input[name='sort']")?.value;
      const dir = form.querySelector("input[name='dir']")?.value;

      if (src) params.set("src_ip", src);
      if (dst) params.set("dst_ip", dst);
      if (dport) params.set("dport", dport);
      if (proto) params.set("proto", proto);
      if (hide) params.set("hide_time_wait", "true");
      if (onlyNew) params.set("only_new", "true");
      if (includeStale) params.set("include_stale", "true");
      if (minScore) params.set("min_score", minScore);
      if (sort) params.set("sort", sort);
      if (dir) params.set("dir", dir);
      params.set("page", currentPage);
      params.set("per_page", perPageSelect ? perPageSelect.value : "200");

      const query = params.toString();
      return query ? `?${query}` : "";
    }

    function refresh() {
      if (document.activeElement && document.activeElement.classList.contains("device-name-input")) {
        return;
      }
      const query = buildConnectionsQuery();
      fetch(`/connections.json${query}`)
        .then((resp) => resp.json())
        .then((payload) => {
          const data = Array.isArray(payload) ? payload : payload.data || [];
          const meta = payload.meta || {};
          totalRows = meta.total || data.length;
          const perPage = Number(meta.per_page || (perPageSelect ? perPageSelect.value : 200));
          const totalPages = perPage > 0 ? Math.max(1, Math.ceil(totalRows / perPage)) : 1;
          if (currentPage > totalPages) {
            currentPage = totalPages;
          }
          if (pageInfoEl) {
            pageInfoEl.textContent = `Page ${currentPage} of ${totalPages} (${totalRows} total)`;
          }
          if (prevBtn) prevBtn.disabled = currentPage <= 1;
          if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
          body.innerHTML = data.map(renderRow).join("");
          applyColumnVisibility();
        })
        .catch(() => {});
    }

    if (perPageSelect) {
      const savedPerPage = localStorage.getItem(perPageStorageKey);
      if (savedPerPage) perPageSelect.value = savedPerPage;
    }

    if (prevBtn) {
      prevBtn.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage -= 1;
          refresh();
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener("click", () => {
        currentPage += 1;
        refresh();
      });
    }

    if (perPageSelect) {
      perPageSelect.addEventListener("change", () => {
        localStorage.setItem(perPageStorageKey, perPageSelect.value);
        currentPage = 1;
        refresh();
      });
    }

    const filterForm = document.getElementById("connections-filter");
    if (filterForm) {
      filterForm.addEventListener("submit", (event) => {
        event.preventDefault();
        currentPage = 1;
        refresh();
      });
    }

    refresh();
    setInterval(refresh, 1000);

    const csrfToken = document.querySelector("meta[name='csrf-token']")?.content;
    let pendingSave = null;

    function saveDeviceName(input) {
      const deviceId = input.dataset.deviceId;
      if (!deviceId) return;
      if (!csrfToken) return;

      const name = input.value.trim();
      if (pendingSave) clearTimeout(pendingSave);
      pendingSave = setTimeout(() => {
        fetch(`/devices/${deviceId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": csrfToken,
            "Accept": "application/json"
          },
          body: JSON.stringify({ device: { name } })
        }).catch(() => {});
      }, 200);
    }

    body.addEventListener("change", (event) => {
      const target = event.target;
      if (target && target.classList.contains("device-name-input")) {
        saveDeviceName(target);
      }
    });

    body.addEventListener("keydown", (event) => {
      const target = event.target;
      if (!target || !target.classList.contains("device-name-input")) return;
      if (event.key === "Enter") {
        event.preventDefault();
        target.blur();
      }
    });

    body.addEventListener("click", (event) => {
      const target = event.target;
      if (!target || !target.classList.contains("allow-port-btn")) return;
      const deviceId = target.dataset.deviceId;
      const port = target.dataset.port;
      if (!deviceId || !port || !csrfToken) return;
      fetch("/allowlist_rules", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken,
          "Accept": "application/json"
        },
        body: JSON.stringify({ allowlist_rule: { kind: "device_port", value: port, device_id: deviceId } })
      }).catch(() => {});
    });

    const loadavgEl = document.getElementById("metric-loadavg");
    const collectorEl = document.getElementById("metric-collector");
    const memEl = document.getElementById("metric-mem");
    const ifacesEl = document.getElementById("metric-ifaces");
    const interfacesInput = document.getElementById("metric-interfaces");
    const newDstEl = document.getElementById("metric-new-dst");
    const uniqueDportsEl = document.getElementById("metric-unique-dports");
    const uplinkBytesEl = document.getElementById("metric-uplink-bytes");
    const newAsnsEl = document.getElementById("metric-new-asns");
    const anomaliesEl = document.getElementById("metric-anomalies");
    const metricsUpdatedEl = document.getElementById("metrics-updated");
    const detailEl = document.getElementById("metric-detail");
    const detailTitleEl = document.getElementById("metric-detail-title");
    const detailBodyEl = document.getElementById("metric-detail-body");
    const rarePortsList = document.getElementById("panel-rare-ports");
    const drilldownOverlay = document.getElementById("drilldown-overlay");
    const drilldownClose = document.getElementById("drilldown-close");
    const drilldownTitle = document.getElementById("drilldown-title");
    const drilldownWindow = document.getElementById("drilldown-window");
    const drilldownGenerated = document.getElementById("drilldown-generated");
    const drilldownBody = document.getElementById("drilldown-body");
    const drilldownWarning = document.getElementById("drilldown-warning");
    const drilldownCopyPorts = document.getElementById("drilldown-copy-ports");
    const drilldownCopyIps = document.getElementById("drilldown-copy-ips");
    const drilldownPrev = document.getElementById("drilldown-prev");
    const drilldownNext = document.getElementById("drilldown-next");
    const drilldownPageEl = document.getElementById("drilldown-page");
    const chartModal = document.getElementById("chart-modal");
    const chartModalClose = document.getElementById("chart-modal-close");
    const chartModalTitle = document.getElementById("chart-modal-title");
    const chartModalCanvas = document.getElementById("chart-modal-canvas");

    let lastAnalytics = null;

    function renderHostList(hosts) {
      if (!hosts || hosts.length === 0) return "<div class=\"text-sm text-zinc-200\">None</div>";
      return hosts.map((host) => {
        const whois = host.whois || "--";
        const rdns = host.rdns || "--";
        const title = host.whois_raw || "";
        return `<div class="text-sm text-zinc-200 mb-1" title="${title}">${host.ip} — rDNS: ${rdns} — WHOIS: ${whois}</div>`;
      }).join("");
    }

    function showDetail(title, html) {
      if (!detailEl) return;
      detailTitleEl.textContent = title;
      detailBodyEl.innerHTML = html;
      detailEl.classList.remove("hidden");
    }

    function closeDrilldown() {
      if (drilldownOverlay) drilldownOverlay.classList.add("hidden");
    }

    const drilldownState = { kind: null, window: null, title: null, options: {}, page: 1, totalPages: 1 };

    function openDrilldown(kind, window, title, options = {}) {
      if (!drilldownOverlay) return;
      drilldownState.kind = kind;
      drilldownState.window = window;
      drilldownState.title = title;
      drilldownState.options = options;
      drilldownState.page = 1;
      if (drilldownTitle) drilldownTitle.textContent = title;
      if (drilldownWindow) drilldownWindow.textContent = `Window: ${window}`;
      if (drilldownGenerated) drilldownGenerated.textContent = "Generated: --";
      if (drilldownBody) drilldownBody.innerHTML = "<div class=\"text-sm text-zinc-200\">Loading...</div>";
      if (drilldownWarning) drilldownWarning.classList.add("hidden");
      if (drilldownCopyPorts) drilldownCopyPorts.classList.add("hidden");
      if (drilldownCopyIps) drilldownCopyIps.classList.add("hidden");
      if (drilldownPrev) drilldownPrev.disabled = true;
      if (drilldownNext) drilldownNext.disabled = true;
      if (drilldownPageEl) drilldownPageEl.textContent = "Page 1";
      drilldownOverlay.classList.remove("hidden");

      loadDrilldownPage(1);
    }

    function loadDrilldownPage(page) {
      if (!drilldownState.kind) return;
      drilldownState.page = page;
      const params = new URLSearchParams();
      params.set("window", drilldownState.window);
      params.set("page", drilldownState.page);
      if (drilldownState.options.deviceId) params.set("device_id", drilldownState.options.deviceId);

      fetch(`/drilldowns/${drilldownState.kind}.json?${params.toString()}`)
        .then((resp) => resp.json())
        .then((data) => {
          if (drilldownGenerated && data.generated_at) {
            drilldownGenerated.textContent = `Generated: ${data.generated_at}`;
          }
          const rows = (data.rows || []).filter((row) => {
            if (drilldownState.options.port && row.dst_port != null) {
              return String(row.dst_port) === String(drilldownState.options.port);
            }
            return true;
          });
          if (drilldownWarning) {
            if (data.limited) drilldownWarning.classList.remove("hidden");
            else drilldownWarning.classList.add("hidden");
          }
          drilldownState.totalPages = data.total_pages || 1;
          if (drilldownPageEl) {
            drilldownPageEl.textContent = `Page ${data.page || 1} of ${drilldownState.totalPages}`;
          }
          if (drilldownPrev) drilldownPrev.disabled = (data.page || 1) <= 1;
          if (drilldownNext) drilldownNext.disabled = (data.page || 1) >= drilldownState.totalPages;

          const ports = rows.map((row) => row.dst_port).filter((p) => p != null);
          const ips = rows.map((row) => row.dst_ip).filter((ip) => ip);
          if (drilldownCopyPorts) {
            if (ports.length > 0) drilldownCopyPorts.classList.remove("hidden");
            else drilldownCopyPorts.classList.add("hidden");
            drilldownCopyPorts.onclick = () => {
              navigator.clipboard?.writeText([...new Set(ports)].join("\n"));
            };
          }
          if (drilldownCopyIps) {
            if (ips.length > 0) drilldownCopyIps.classList.remove("hidden");
            else drilldownCopyIps.classList.add("hidden");
            drilldownCopyIps.onclick = () => {
              navigator.clipboard?.writeText([...new Set(ips)].join("\n"));
            };
          }

          const html = rows.map((row, index) => {
            const bytes = formatBytes(row.bytes);
            const port = row.dst_port != null ? row.dst_port : "--";
            const ipLink = row.dst_ip ? `<a class="text-cyan-200 hover:text-cyan-100" href="/remote_hosts/${row.dst_ip}" target="_blank" rel="noopener">${row.dst_ip}</a>` : "--";
            const count = row.count != null ? row.count : null;
            const firstSeen = row.first_seen_at || "--";
            const lastSeen = row.last_seen_at || "--";
            const ipsList = (row.ips || []).map((ip) => `<a class="text-cyan-200 hover:text-cyan-100 mr-2" href="/remote_hosts/${ip}" target="_blank" rel="noopener">${ip}</a>`).join("");
            const ipsSection = row.ips && row.ips.length > 0
              ? `<div class="mt-2 text-xs text-zinc-300">
                   <button type="button" class="text-cyan-200 hover:text-cyan-100 drilldown-ips-toggle" data-index="${index}">View IPs (${row.ips.length})</button>
                   <div class="hidden mt-1" id="drilldown-ips-${index}">${ipsList}</div>
                 </div>`
              : "";
            const timingSection = count != null
              ? `<div class="mt-2 text-xs text-zinc-300">First Seen: ${firstSeen} · Last Seen: ${lastSeen} · Count: ${count}</div>`
              : "";
            return `
              <div class="border border-zinc-800/60 rounded-xl p-3 bg-black/60">
                <div class="grid grid-cols-2 gap-2 text-sm text-zinc-200">
                  <div><span class="text-xs uppercase tracking-wider text-zinc-500">Timestamp</span><div>${row.timestamp || "--"}</div></div>
                  <div><span class="text-xs uppercase tracking-wider text-zinc-500">Device</span><div>${row.device || "--"}</div></div>
                  <div><span class="text-xs uppercase tracking-wider text-zinc-500">Proto</span><div>${row.proto || "--"}</div></div>
                  <div><span class="text-xs uppercase tracking-wider text-zinc-500">Dst</span><div>${ipLink}</div></div>
                  <div><span class="text-xs uppercase tracking-wider text-zinc-500">Port</span><div>${port}</div></div>
                  <div><span class="text-xs uppercase tracking-wider text-zinc-500">Bytes</span><div title="${row.bytes || 0}">${bytes}</div></div>
                </div>
                <div class="mt-2 text-xs text-emerald-200">Why: ${row.reason || drilldownState.kind}</div>
                ${timingSection}
                ${ipsSection}
              </div>
            `;
          }).join("");

          drilldownBody.innerHTML = html || "<div class=\"text-sm text-zinc-200\">No results.</div>";
          drilldownBody.querySelectorAll(".drilldown-ips-toggle").forEach((button) => {
            button.addEventListener("click", () => {
              const idx = button.dataset.index;
              const panel = document.getElementById(`drilldown-ips-${idx}`);
              if (!panel) return;
              panel.classList.toggle("hidden");
            });
          });
        })
        .catch(() => {
          if (drilldownBody) drilldownBody.innerHTML = "<div class=\"text-sm text-zinc-200\">Failed to load drilldown.</div>";
        });
    }

    if (drilldownClose) {
      drilldownClose.addEventListener("click", closeDrilldown);
    }
    if (drilldownPrev) {
      drilldownPrev.addEventListener("click", () => {
        if (drilldownState.page > 1) loadDrilldownPage(drilldownState.page - 1);
      });
    }
    if (drilldownNext) {
      drilldownNext.addEventListener("click", () => {
        if (drilldownState.page < drilldownState.totalPages) loadDrilldownPage(drilldownState.page + 1);
      });
    }
    if (drilldownOverlay) {
      drilldownOverlay.addEventListener("click", (event) => {
        if (event.target && event.target.classList.contains("drilldown-backdrop")) closeDrilldown();
      });
    }
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeDrilldown();
        closeChartModal();
      }
    });

    function closeChartModal() {
      if (chartModal) chartModal.classList.add("hidden");
    }

    function openChartModal(title, points, color, windowLabel) {
      if (!chartModal || !chartModalCanvas) return;
      chartModalTitle.textContent = `${title} (${windowLabel || "10m"})`;
      chartModal.classList.remove("hidden");
      requestAnimationFrame(() => {
        drawLineWithScale(chartModalCanvas, points, color || "#22d3ee");
      });
    }

    if (chartModalClose) {
      chartModalClose.addEventListener("click", closeChartModal);
    }
    if (chartModal) {
      chartModal.addEventListener("click", (event) => {
        if (event.target && event.target.classList.contains("chart-backdrop")) closeChartModal();
      });
    }

    const graphs = {
      newDst: { canvas: document.getElementById("graph-new-dst"), color: "#22d3ee" },
      uniqueDports: { canvas: document.getElementById("graph-unique-dports"), color: "#38bdf8" },
      uplinkBytes: { canvas: document.getElementById("graph-uplink-bytes"), color: "#34d399" },
      newAsns: { canvas: document.getElementById("graph-new-asns"), color: "#5eead4" }
    };

    const graphSeriesState = {};

    function drawLineWithScale(canvas, points, color) {
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const width = canvas.width = canvas.clientWidth;
      const height = canvas.height = canvas.clientHeight;
      ctx.clearRect(0, 0, width, height);

      if (!points || points.length === 0) {
        ctx.fillStyle = "#71717a";
        ctx.font = "12px sans-serif";
        ctx.fillText("No data yet", 10, 20);
        return;
      }

      const min = Math.min(...points);
      const max = Math.max(...points);
      const range = max - min || 1;

      const leftPad = 28;
      const rightPad = 6;
      const topPad = 6;
      const bottomPad = 12;
      const plotWidth = width - leftPad - rightPad;
      const plotHeight = height - topPad - bottomPad;

      ctx.strokeStyle = "#3f3f46";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(leftPad, topPad);
      ctx.lineTo(leftPad, topPad + plotHeight);
      ctx.lineTo(leftPad + plotWidth, topPad + plotHeight);
      ctx.stroke();

      ctx.fillStyle = "#71717a";
      ctx.font = "10px sans-serif";
      ctx.fillText(String(max), 2, topPad + 8);
      ctx.fillText(String(min), 2, topPad + plotHeight);

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((val, idx) => {
        const x = leftPad + (idx / (points.length - 1 || 1)) * plotWidth;
        const y = topPad + plotHeight - ((val - min) / range) * plotHeight;
        if (idx === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    function renderMetrics(payload) {
      if (metricsUpdatedEl && payload.timestamp) {
        metricsUpdatedEl.textContent = payload.timestamp;
      }
      if (loadavgEl && payload.loadavg) {
        const { one, five, fifteen } = payload.loadavg;
        loadavgEl.textContent = `${one ?? "--"} / ${five ?? "--"} / ${fifteen ?? "--"}`;
      }
      if (collectorEl) {
        const age = payload.collector?.age_seconds;
        if (age == null) {
          collectorEl.textContent = "Unknown";
          collectorEl.className = "text-zinc-200";
        } else {
          const statusClass = age <= 10 ? "text-emerald-300" : "text-red-300";
          const label = age <= 10 ? "OK" : "Stale";
          collectorEl.textContent = `${label} (${age}s ago)`;
          collectorEl.className = statusClass;
        }
      }
      if (memEl && payload.meminfo) {
        const total = payload.meminfo.total_kb || 0;
        const avail = payload.meminfo.available_kb || 0;
        const used = total - avail;
        memEl.textContent = `${used}k / ${total}k`;
      }
      if (ifacesEl) {
        const lines = (payload.interfaces || []).map((iface) => {
          return `${iface.name}: rx ${formatBytes(iface.rx_bytes ?? 0)}, tx ${formatBytes(iface.tx_bytes ?? 0)}`;
        });
        ifacesEl.textContent = lines.length > 0 ? lines.join(" | ") : "--";
      }

      if (payload.analytics) {
        lastAnalytics = payload.analytics;
        // Stat cards are updated via series fetches to respect per-card windows.
        if (anomaliesEl) {
          const list = (payload.analytics.anomalies || []).map((a) => a.rule);
          const asns = payload.analytics.new_asns_list || [];
          const extra = asns.length > 0 ? ` | ASNs: ${asns.join(", ")}` : "";
          anomaliesEl.textContent = list.length > 0 ? `${list.join("; ")}${extra}` : "None";
        }
      }

      // Graphs are updated via /metrics/series to respect per-graph time windows.
    }

    if (newDstEl) {
      newDstEl.addEventListener("click", () => {
        const window = document.querySelector(".stat-window[data-series='new_dst_ips_last_10m']")?.value || "10m";
        openDrilldown("new_dst", window, "New DST IPs");
      });
    }

    if (uniqueDportsEl) {
      uniqueDportsEl.addEventListener("click", () => {
        const window = document.querySelector(".stat-window[data-series='unique_dports_last_10m']")?.value || "10m";
        openDrilldown("unique_ports", window, "Unique DPorts");
      });
    }

    if (newAsnsEl) {
      newAsnsEl.addEventListener("click", () => {
        const window = document.querySelector(".stat-window[data-series='new_asns_last_1h']")?.value || "1h";
        openDrilldown("new_asns", window, "New ASNs");
      });
    }

    if (rarePortsList) {
      rarePortsList.addEventListener("click", (event) => {
        const target = event.target;
        if (!target || !target.classList.contains("rare-port-item")) return;
        const port = target.dataset.port;
        const window = document.querySelector(".panel-window[data-panel='rare']")?.value || "24h";
        if (port === "all") {
          openDrilldown("rare_ports", window, "Rare Ports");
        } else {
          openDrilldown("rare_ports", window, `Rare Port ${port}`, { port: port });
        }
      });
    }

    function refreshMetrics() {
      const interfaces = interfacesInput ? interfacesInput.value.trim() : "";
      const query = interfaces ? `?interfaces=${encodeURIComponent(interfaces)}` : "";
      fetch(`/metrics.json${query}`)
        .then((resp) => resp.json())
        .then(renderMetrics)
        .catch(() => {});
    }

    refreshMetrics();
    setInterval(refreshMetrics, 2000);

    if (interfacesInput) {
      let metricsTimer = null;
      interfacesInput.addEventListener("input", () => {
        clearTimeout(metricsTimer);
        metricsTimer = setTimeout(refreshMetrics, 200);
      });
    }

    function updateStatCard(seriesKey, window, el, formatter) {
      if (!el) return Promise.resolve();
      return fetchSeries(window).then((series) => {
        const points = series[seriesKey] || [];
        const last = points.length > 0 ? points[points.length - 1] : 0;
        const value = formatter ? formatter(last) : last;
        el.textContent = value;
        el.title = last;
      });
    }

    const windowStorageKey = "netmon.graph.windows";

    function loadWindowSelections() {
      let stored = {};
      try {
        stored = JSON.parse(localStorage.getItem(windowStorageKey) || "{}");
      } catch (e) {
        stored = {};
      }
      document.querySelectorAll(".graph-window").forEach((select) => {
        const key = `graph:${select.dataset.series}`;
        if (stored[key]) select.value = stored[key];
      });
      document.querySelectorAll(".system-window").forEach((select) => {
        const key = `system:${select.dataset.metric}`;
        if (stored[key]) select.value = stored[key];
      });
      document.querySelectorAll(".stat-window").forEach((select) => {
        const key = `stat:${select.dataset.series}`;
        if (stored[key]) select.value = stored[key];
      });
    }

    function persistWindowSelection(kind, key, value) {
      let stored = {};
      try {
        stored = JSON.parse(localStorage.getItem(windowStorageKey) || "{}");
      } catch (e) {
        stored = {};
      }
      stored[`${kind}:${key}`] = value;
      localStorage.setItem(windowStorageKey, JSON.stringify(stored));
    }

    loadWindowSelections();

    function refreshStatSeries() {
      document.querySelectorAll(".stat-window").forEach((select) => {
        const seriesKey = select.dataset.series;
        const window = select.value;
        if (seriesKey === "uplink_bytes_last_10m") {
          updateStatCard(seriesKey, window, uplinkBytesEl, formatBytes);
        } else if (seriesKey === "new_dst_ips_last_10m") {
          updateStatCard(seriesKey, window, newDstEl);
        } else if (seriesKey === "unique_dports_last_10m") {
          updateStatCard(seriesKey, window, uniqueDportsEl);
        } else if (seriesKey === "new_asns_last_1h") {
          updateStatCard(seriesKey, window, newAsnsEl);
        }
      });
    }

    refreshStatSeries();
    setInterval(refreshStatSeries, 10000);

    document.querySelectorAll(".stat-window").forEach((select) => {
      select.addEventListener("change", () => {
        const seriesKey = select.dataset.series;
        persistWindowSelection("stat", seriesKey, select.value);
        refreshStatSeries();
      });
    });

    function refreshGraphSeries() {
      document.querySelectorAll(".graph-window").forEach((select) => {
        const seriesKey = select.dataset.series;
        const window = select.value;
        if (window) persistWindowSelection("graph", seriesKey, window);
        fetchSeries(window).then((series) => {
          const points = series[seriesKey] || [];
          const canvas = document.querySelector(`canvas[data-series="${seriesKey}"]`);
          updateGraph(canvas, seriesKey, points, window);
        }).catch(() => {});
      });
    }

    refreshGraphSeries();
    setInterval(refreshGraphSeries, 10000);


    function seriesKeyFromCanvas(canvas) {
      return canvas?.dataset.series;
    }

    function fetchSeries(window) {
      return fetch(`/metrics/series.json?window=${encodeURIComponent(window)}`)
        .then((resp) => resp.json());
    }

    function updateGraph(canvas, seriesKey, points, windowLabel) {
      const color = Object.values(graphs).find((g) => g.canvas === canvas)?.color || "#36c";
      drawLineWithScale(canvas, points || [], color);
      if (canvas) canvas.dataset.color = color;
      graphSeriesState[seriesKey] = { points: points || [], window: windowLabel };
      if (canvas && windowLabel) {
        const label = document.querySelector(`[data-range-label="${canvas.id}"]`);
        if (label) label.textContent = `Last ${windowLabel}`;
      }
    }

    document.querySelectorAll(".graph-window").forEach((select) => {
      select.addEventListener("change", () => {
        const window = select.value;
        const seriesKey = select.dataset.series;
        persistWindowSelection("graph", seriesKey, window);
        if (graphSeriesState[seriesKey]) {
          graphSeriesState[seriesKey].window = window;
        } else {
          graphSeriesState[seriesKey] = { points: [], window: window };
        }
        fetchSeries(window).then((series) => {
          const points = series[seriesKey] || [];
          const canvas = document.querySelector(`canvas[data-series="${seriesKey}"]`);
          const color = Object.values(graphs).find((g) => g.canvas === canvas)?.color || "#36c";
          if (canvas) canvas.dataset.color = color;
          updateGraph(canvas, seriesKey, points, window);
        }).catch(() => {});
      });
    });

    window.addEventListener("popstate", refreshGraphSeries);

    Object.values(graphs).forEach((graph) => {
      if (!graph.canvas) return;
      graph.canvas.addEventListener("click", () => {
        const seriesKey = seriesKeyFromCanvas(graph.canvas);
        const state = graphSeriesState[seriesKey];
        if (!state || state.points.length === 0) return;
        const title = seriesKey.replace(/_/g, " ");
        const color = graph.canvas.dataset.color || graph.color;
        openChartModal(title, state.points, color, state.window);
      });
    });

    const systemSeriesState = {};

    function fetchSystemSeries(metric, window) {
      return fetch(`/system/series.json?metric=${encodeURIComponent(metric)}&window=${encodeURIComponent(window)}`)
        .then((resp) => resp.json());
    }

    function updateSystemGraph(canvas, metric, points, windowLabel) {
      const color = "#22d3ee";
      drawLineWithScale(canvas, points || [], color);
      systemSeriesState[metric] = { points: points || [], window: windowLabel };
      if (canvas && windowLabel) {
        const label = document.querySelector(`[data-range-label="${canvas.id}"]`);
        if (label) label.textContent = `Last ${windowLabel}`;
      }
    }

    function refreshSystemGraphs() {
      document.querySelectorAll(".system-window").forEach((select) => {
        const metric = select.dataset.metric;
        const window = select.value;
        if (window) persistWindowSelection("system", metric, window);
        fetchSystemSeries(metric, window).then((series) => {
          const points = series.values || [];
          const canvas = document.querySelector(`canvas[data-metric="${metric}"]`);
          updateSystemGraph(canvas, metric, points, window);
        }).catch(() => {});
      });
    }

    refreshSystemGraphs();
    setInterval(refreshSystemGraphs, 10000);

    document.querySelectorAll(".system-window").forEach((select) => {
      select.addEventListener("change", () => {
        const metric = select.dataset.metric;
        persistWindowSelection("system", metric, select.value);
        refreshSystemGraphs();
      });
    });

    document.querySelectorAll("canvas[data-metric]").forEach((canvas) => {
      canvas.addEventListener("click", () => {
        const metric = canvas.dataset.metric;
        const state = systemSeriesState[metric];
        if (!state || state.points.length === 0) return;
        const title = metric.replace(/_/g, " ");
        openChartModal(title, state.points, "#22d3ee", state.window);
      });
    });

    const columnStorageKey = "netmon.columns.connections";
    const columnsConfig = [
      { key: "proto", label: "Proto" },
      { key: "device", label: "Device" },
      { key: "source", label: "Source" },
      { key: "destination", label: "Destination" },
      { key: "state", label: "State" },
      { key: "flags", label: "Flags" },
      { key: "up", label: "Up" },
      { key: "down", label: "Down" },
      { key: "total", label: "Total" },
      { key: "score", label: "Score" },
      { key: "reasons", label: "Reasons" },
      { key: "allow", label: "Allow" },
      { key: "age", label: "Age" },
      { key: "rdns", label: "rDNS" },
      { key: "whois", label: "WHOIS" },
      { key: "seen", label: "Seen" }
    ];
    const defaultColumns = ["proto", "device", "destination", "state", "flags", "up", "down", "total", "score", "reasons", "rdns", "whois"];
    let enabledColumns = [];

    function loadColumnPreferences() {
      try {
        const stored = JSON.parse(localStorage.getItem(columnStorageKey) || "null");
        if (Array.isArray(stored) && stored.length > 0) {
          enabledColumns = stored;
          return;
        }
      } catch (e) {}
      enabledColumns = defaultColumns.slice();
      localStorage.setItem(columnStorageKey, JSON.stringify(enabledColumns));
    }

    function ensureDefaultColumn(key) {
      if (!enabledColumns.includes(key)) {
        enabledColumns.push(key);
        localStorage.setItem(columnStorageKey, JSON.stringify(enabledColumns));
      }
    }

    function applyColumnVisibility() {
      const enabled = new Set(enabledColumns);
      document.querySelectorAll("[data-col]").forEach((el) => {
        const key = el.dataset.col;
        if (!key) return;
        if (enabled.has(key)) el.classList.remove("hidden");
        else el.classList.add("hidden");
      });
    }

    function renderColumnToggles() {
      const container = document.getElementById("columns-toggle");
      if (!container) return;
      container.innerHTML = columnsConfig.map((col) => {
        const checked = enabledColumns.includes(col.key) ? "checked" : "";
        return `
          <label class="flex items-center gap-2">
            <input type="checkbox" class="rounded border-zinc-700 bg-black text-cyan-400" data-column="${col.key}" ${checked}>
            <span>${col.label}</span>
          </label>
        `;
      }).join("");

      container.querySelectorAll("input[type='checkbox']").forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          const key = checkbox.dataset.column;
          if (!key) return;
          if (checkbox.checked) {
            if (!enabledColumns.includes(key)) enabledColumns.push(key);
          } else {
            enabledColumns = enabledColumns.filter((col) => col !== key);
          }
          localStorage.setItem(columnStorageKey, JSON.stringify(enabledColumns));
          applyColumnVisibility();
        });
      });
    }

    loadColumnPreferences();
    ensureDefaultColumn("up");
    ensureDefaultColumn("down");
    ensureDefaultColumn("state");
    ensureDefaultColumn("flags");
    ensureDefaultColumn("rdns");
    renderColumnToggles();
    applyColumnVisibility();

    const topRemoteHostsEl = document.getElementById("panel-top-remote-hosts");
    const newestRemoteHostsEl = document.getElementById("panel-newest-remote-hosts");
    const newestViewAllEl = document.getElementById("panel-newest-viewall");
    const rarePortsEl = document.getElementById("panel-rare-ports");
    const topDevicesEgressEl = document.getElementById("panel-top-devices-egress");
    const recentIncidentsEl = document.getElementById("panel-recent-incidents");

    function renderPanelList(el, items) {
      if (!el) return;
      el.innerHTML = items.map((item) => `<li>${item}</li>`).join("");
    }

    function refreshTopPanels() {
      const panelParams = new URLSearchParams();
      let newestWindow = "10m";
      document.querySelectorAll(".panel-window").forEach((select) => {
        const panel = select.dataset.panel;
        if (panel === "top-remote") panelParams.set("top_remote_window", select.value);
        if (panel === "newest") {
          panelParams.set("newest_window", select.value);
          newestWindow = select.value;
        }
        if (panel === "rare") panelParams.set("rare_window", select.value);
        if (panel === "devices-egress") panelParams.set("top_devices_window", select.value);
      });
      const query = panelParams.toString();
      const url = query ? `/dashboard/top_panels.json?${query}` : "/dashboard/top_panels.json";
      fetch(url)
        .then((resp) => resp.json())
        .then((data) => {
          const topRemote = (data.top_remote_hosts || []).map((row) => {
            const formatted = formatBytes(row.total_bytes);
            return `<a href="/remote_hosts/${row.ip}">${row.ip}</a> (<span title="${row.total_bytes}">${formatted}</span>)`;
          });
          const newest = (data.newest_remote_hosts || []).map((row) => {
            const label = `${row.ip}${row.port ? `:${row.port}` : ""}`;
            return `<a href="/remote_hosts/${row.ip}">${label}</a>`;
          });
          const topDevices = (data.top_devices_egress || []).map((row) => `${row.label} (<span title="${row.total_uplink}">${formatBytes(row.total_uplink)}</span>)`);
          renderPanelList(topRemoteHostsEl, topRemote);
          renderPanelList(newestRemoteHostsEl, newest);
          if (newestViewAllEl) {
            newestViewAllEl.setAttribute("href", `/remote_hosts?window=${encodeURIComponent(newestWindow)}`);
          }
          renderPanelList(topDevicesEgressEl, topDevices);

          if (rarePortsEl) {
            const rows = (data.rare_ports || []).filter((row) => row && row.port != null);
            const items = rows.map((row) => {
              const ipSnippet = (row.ips || []).slice(0, 2).join(", ");
              const suffix = ipSnippet ? ` — ${ipSnippet}` : "";
              return `<button type="button" class="rare-port-item text-cyan-200 hover:text-cyan-100 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black rounded" data-port="${row.port}">${row.port} (${row.count})${suffix}</button>`;
            });
            const allItem = `<button type="button" class="rare-port-item text-cyan-200 hover:text-cyan-100 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black rounded" data-port="all">View All</button>`;
            rarePortsEl.innerHTML = [allItem, ...items].map((item) => `<li>${item}</li>`).join("");
          }

          if (recentIncidentsEl) {
            const incidents = (data.recent_incidents || []).map((incident) => {
              const dst = incident.dst_ip ? `${incident.dst_ip}${incident.dst_port ? `:${incident.dst_port}` : ""}` : "device-level";
              const device = incident.device ? `${incident.device}` : "";
              const codes = incident.codes ? ` ${incident.codes}` : "";
              const count = incident.count ? ` x${incident.count}` : "";
              return `<a href="/incidents/${incident.id}">${device} ${dst} (${incident.max_score})${codes}${count}</a>`;
            });
            renderPanelList(recentIncidentsEl, incidents);
          }
        })
        .catch(() => {});
    }

    refreshTopPanels();
    setInterval(refreshTopPanels, 2000);

    document.querySelectorAll(".panel-window").forEach((select) => {
      select.addEventListener("change", refreshTopPanels);
    });
  })();
</script>
