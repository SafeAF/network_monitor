<% input_class = "bg-black border border-zinc-800 rounded-lg px-2 py-1.5 text-zinc-200 placeholder:text-zinc-600 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black" %>
<% checkbox_class = "rounded border-zinc-700 bg-black text-cyan-400 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black" %>
<% button_primary = "bg-emerald-600/20 text-emerald-200 border border-emerald-700/40 hover:bg-emerald-600/30 rounded-lg px-3 py-1 text-sm" %>
<% button_secondary = "bg-cyan-600/15 text-cyan-200 border border-cyan-700/40 hover:bg-cyan-600/25 rounded-lg px-3 py-1 text-sm" %>
<% button_neutral = "bg-zinc-900/50 text-zinc-200 border border-zinc-800 hover:bg-zinc-900/80 rounded-lg px-3 py-1 text-sm" %>

<h1 class="text-xl text-emerald-300 font-semibold tracking-wide mb-3">Active Connections</h1>

<form method="get" class="mb-4" id="connections-filter">
  <%= render "shared/filter_bar" do %>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Src IP
      <input class="<%= input_class %>" name="src_ip" value="<%= params[:src_ip].to_s %>">
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Dst IP
      <input class="<%= input_class %>" name="dst_ip" value="<%= params[:dst_ip].to_s %>">
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Dst Port
      <input class="<%= input_class %>" name="dport" value="<%= params[:dport].to_s %>">
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Proto
      <input class="<%= input_class %>" name="proto" value="<%= params[:proto].to_s %>">
    </label>
    <label class="flex items-center gap-2 text-xs uppercase tracking-wider text-zinc-400 mt-4">
      <input type="checkbox" class="<%= checkbox_class %>" name="hide_time_wait" value="true" <%= "checked" if params[:hide_time_wait].present? %>>
      Hide TIME_WAIT
    </label>
    <label class="flex items-center gap-2 text-xs uppercase tracking-wider text-zinc-400 mt-4">
      <input type="checkbox" class="<%= checkbox_class %>" name="only_new" value="true" <%= "checked" if params[:only_new].present? %>>
      Only NEW
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Min Score
      <select class="<%= input_class %>" name="min_score">
        <option value="" <%= "selected" if params[:min_score].to_s.empty? %>>All</option>
        <option value="0" <%= "selected" if params[:min_score] == "0" %>>0</option>
        <option value="20" <%= "selected" if params[:min_score] == "20" %>>20</option>
        <option value="50" <%= "selected" if params[:min_score] == "50" %>>50</option>
      </select>
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-400">
      Interfaces
      <input id="metric-interfaces" class="<%= input_class %>" name="interfaces" value="<%= params[:interfaces].to_s %>" list="interface-options">
      <datalist id="interface-options">
        <option value="enp42s0"></option>
        <option value="enp2s0"></option>
        <option value="enp3s0"></option>
      </datalist>
    </label>
    <div class="flex flex-wrap items-center gap-2 ml-auto">
      <button type="submit" class="<%= button_primary %>">Apply</button>
      <a href="/" class="<%= button_neutral %>">Clear</a>
      <a href="?only_new=true" class="<%= button_secondary %>">Only NEW</a>
      <a href="?hide_time_wait=true" class="<%= button_secondary %>">Hide TIME_WAIT</a>
      <a href="?min_score=0" class="<%= button_neutral %>">Score 0+</a>
      <a href="?min_score=20" class="<%= button_neutral %>">Score 20+</a>
      <a href="?min_score=50" class="<%= button_neutral %>">Score 50+</a>
    </div>
  <% end %>
</form>

<section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-6 gap-3 mb-4">
  <%= render "shared/card" do %>
    <%= render "shared/stat", label: "Load Avg", value: "<span id='metric-loadavg'>--</span>".html_safe %>
  <% end %>
  <%= render "shared/card" do %>
  <%= render "shared/stat", label: "Collector", value: "<span id='metric-collector'>--</span>".html_safe, value_class: "text-emerald-300" %>
  <% end %>
  <%= render "shared/card" do %>
    <%= render "shared/stat", label: "Memory", value: "<span id='metric-mem'>--</span>".html_safe %>
  <% end %>
  <%= render "shared/card" do %>
    <%= render "shared/stat", label: "Interfaces", value: "<span id='metric-ifaces'>--</span>".html_safe %>
  <% end %>
  <%= render "shared/card" do %>
    <%= render "shared/stat", label: "New DST IPs (10m)", value: "<button type='button' id='metric-new-dst' class='text-cyan-200 hover:text-cyan-100'>--</button>".html_safe %>
  <% end %>
  <%= render "shared/card" do %>
    <%= render "shared/stat", label: "Unique DPorts (10m)", value: "<button type='button' id='metric-unique-dports' class='text-cyan-200 hover:text-cyan-100'>--</button>".html_safe %>
  <% end %>
  <%= render "shared/card" do %>
    <%= render "shared/stat", label: "Uplink Bytes (10m)", value: "<button type='button' id='metric-uplink-bytes' class='text-cyan-200 hover:text-cyan-100'>--</button>".html_safe %>
  <% end %>
  <%= render "shared/card" do %>
    <%= render "shared/stat", label: "New ASNs (1h)", value: "<button type='button' id='metric-new-asns' class='text-cyan-200 hover:text-cyan-100'>--</button>".html_safe %>
  <% end %>
</section>

<section id="metric-detail" class="hidden mb-4">
  <%= render "shared/card" do %>
    <div class="text-xs uppercase tracking-wider text-zinc-500 mb-2" id="metric-detail-title"></div>
    <div id="metric-detail-body" class="text-sm text-zinc-200"></div>
  <% end %>
</section>

<section class="grid grid-cols-1 lg:grid-cols-4 gap-3 mb-4">
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">New DST IPs</h3>
      <select class="graph-window <%= input_class %> text-xs" data-series="new_dst_ips_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-new-dst" data-series="new_dst_ips_last_10m" class="w-full h-32"></canvas>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">Unique DPorts</h3>
      <select class="graph-window <%= input_class %> text-xs" data-series="unique_dports_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-unique-dports" data-series="unique_dports_last_10m" class="w-full h-32"></canvas>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">Uplink Bytes</h3>
      <select class="graph-window <%= input_class %> text-xs" data-series="uplink_bytes_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-uplink-bytes" data-series="uplink_bytes_last_10m" class="w-full h-32"></canvas>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">New ASNs</h3>
      <select class="graph-window <%= input_class %> text-xs" data-series="new_asns_last_1h">
        <option value="10m">10m</option>
        <option value="1h" selected>1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-new-asns" data-series="new_asns_last_1h" class="w-full h-32"></canvas>
  <% end %>
</section>

<%= render "shared/card" do %>
  <div class="flex items-center justify-between gap-3">
    <div class="text-xs uppercase tracking-wider text-zinc-500">Anomalies</div>
    <div id="metric-anomalies" class="text-sm text-amber-200">None</div>
  </div>
<% end %>

<div class="mt-4">
  <%= render "shared/card" do %>
    <div class="text-xs uppercase tracking-wider text-zinc-500 mb-2">Recent Incidents (1h)</div>
    <ol id="panel-recent-incidents" class="space-y-1 text-sm leading-5"></ol>
  <% end %>
</div>

<section class="grid grid-cols-1 lg:grid-cols-4 gap-3 mt-4 mb-4">
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">Top Remote Hosts (10m)</h3>
      <select class="panel-window <%= input_class %> text-xs" data-panel="top-remote" data-default="10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <ol id="panel-top-remote-hosts" class="space-y-1 text-sm">
      <% @top_remote_hosts.each do |row| %>
        <li><a href="/remote_hosts/<%= row[:ip] %>"><%= row[:ip] %></a> (<%= row[:total_bytes].to_i %> bytes)</li>
      <% end %>
    </ol>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">Newest Remote Hosts (10m)</h3>
      <a id="panel-newest-viewall" class="text-xs text-cyan-200 hover:text-cyan-100" href="/remote_hosts?window=10m">View All</a>
    </div>
    <select class="panel-window <%= input_class %> text-xs mb-2" data-panel="newest" data-default="10m">
      <option value="10m" selected>10m</option>
      <option value="1h">1h</option>
      <option value="24h">24h</option>
      <option value="1w">1w</option>
    </select>
    <ol id="panel-newest-remote-hosts" class="space-y-1 text-sm">
      <% @newest_remote_hosts.each do |host| %>
        <li><a href="/remote_hosts/<%= host[:ip] %>"><%= host[:ip] %><%= host[:port] ? ":#{host[:port]}" : "" %></a></li>
      <% end %>
    </ol>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">Rare Ports (24h)</h3>
      <select class="panel-window <%= input_class %> text-xs" data-panel="rare" data-default="24h">
        <option value="10m">10m</option>
        <option value="1h">1h</option>
        <option value="24h" selected>24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <ol id="panel-rare-ports" class="space-y-1 text-sm">
      <li><button type="button" class="rare-port-item text-cyan-200 hover:text-cyan-100 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black rounded" data-port="all">View All</button></li>
      <% @rare_ports.each do |row| %>
        <% ip_snippet = row[:ips].to_a.first(2).join(", ") %>
        <% suffix = ip_snippet.present? ? " — #{ip_snippet}" : "" %>
        <li><button type="button" class="rare-port-item text-cyan-200 hover:text-cyan-100 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black rounded" data-port="<%= row[:port] %>"><%= row[:port] %> (<%= row[:count] %>)<%= suffix %></button></li>
      <% end %>
    </ol>
  <% end %>
  <%= render "shared/card" do %>
    <div class="flex items-center justify-between gap-2 mb-2">
      <h3 class="text-xs uppercase tracking-wider text-zinc-500">Devices by Egress (10m)</h3>
      <select class="panel-window <%= input_class %> text-xs" data-panel="devices-egress" data-default="10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <ol id="panel-top-devices-egress" class="space-y-1 text-sm">
      <% @top_devices_egress.each do |row| %>
        <li><%= row[:label] %> (<%= row[:total_uplink].to_i %> bytes)</li>
      <% end %>
    </ol>
  <% end %>
</section>

<%= render "shared/table" do %>
  <thead class="bg-zinc-950 text-zinc-400 text-xs uppercase tracking-wider">
    <tr>
      <th class="px-2 py-1.5 text-left">Proto</th>
      <th class="px-2 py-1.5 text-left">Device</th>
      <th class="px-2 py-1.5 text-left">Source</th>
      <th class="px-2 py-1.5 text-left">Destination</th>
      <th class="px-2 py-1.5 text-left">State</th>
      <th class="px-2 py-1.5 text-left">Flags</th>
      <th class="px-2 py-1.5 text-right">Up</th>
      <th class="px-2 py-1.5 text-right">Down</th>
      <th class="px-2 py-1.5 text-right">Total</th>
      <th class="px-2 py-1.5 text-left">Score</th>
      <th class="px-2 py-1.5 text-left">Reasons</th>
      <th class="px-2 py-1.5 text-left">Allow</th>
      <th class="px-2 py-1.5 text-left">Age</th>
      <th class="px-2 py-1.5 text-left">rDNS</th>
      <th class="px-2 py-1.5 text-left">WHOIS</th>
      <th class="px-2 py-1.5 text-left">Seen</th>
    </tr>
  </thead>
  <tbody id="connections-body">
    <% @connections.each do |conn| %>
      <% host = @hosts_by_ip[conn.dst_ip] %>
      <% device = @devices_by_ip[conn.src_ip] %>
      <% seen_label = host&.new? ? "NEW" : "SEEN" %>
      <% seen_age = host&.seen_age || "unknown" %>
      <% device_label = device&.name.presence || conn.src_ip %>
      <% reasons = begin
           JSON.parse(conn.anomaly_reasons_json || "[]")
         rescue JSON::ParserError
           []
         end %>
      <% reason_codes = reasons.map { |reason| reason["code"] }.compact %>
      <% score = conn.anomaly_score.to_i %>
      <% score_badge = score >= 70 ? "alert" : (score >= 50 ? "warn" : (score >= 20 ? "info" : "neutral")) %>
      <tr class="odd:bg-black even:bg-zinc-950/30 hover:bg-zinc-900/50">
        <td class="px-2 py-1.5 font-mono text-xs"><%= conn.proto %></td>
        <td class="px-2 py-1.5">
          <% if device %>
            <input class="device-name-input <%= input_class %> text-xs" data-device-id="<%= device.id %>" value="<%= device.name %>" size="12">
          <% else %>
            <%= device_label %>
          <% end %>
        </td>
        <td class="px-2 py-1.5"><a href="/remote_hosts/<%= conn.src_ip %>"><%= conn.src_ip %></a>:<%= conn.src_port %></td>
        <td class="px-2 py-1.5"><a href="/remote_hosts/<%= conn.dst_ip %>"><%= conn.dst_ip %></a>:<%= conn.dst_port %></td>
        <td class="px-2 py-1.5 font-mono text-xs"><%= conn.state %></td>
        <td class="px-2 py-1.5 font-mono text-xs"><%= conn.flags %></td>
        <td class="px-2 py-1.5 text-right"><%= conn.uplink_bytes %></td>
        <td class="px-2 py-1.5 text-right"><%= conn.downlink_bytes %></td>
        <td class="px-2 py-1.5 text-right"><%= conn.uplink_bytes + conn.downlink_bytes %></td>
        <td class="px-2 py-1.5"><%= render "shared/badge", text: score, variant: score_badge %></td>
        <td class="px-2 py-1.5 max-w-[260px] truncate" title="<%= reason_codes.join(",") %>"><%= reason_codes.join(",") %></td>
        <td class="px-2 py-1.5">
          <% if device && conn.dst_port %>
            <%= form_with url: "/allowlist_rules", method: :post, local: true do |form| %>
              <input type="hidden" name="allowlist_rule[kind]" value="device_port">
              <input type="hidden" name="allowlist_rule[value]" value="<%= conn.dst_port %>">
              <input type="hidden" name="allowlist_rule[device_id]" value="<%= device.id %>">
              <button type="submit" class="<%= button_secondary %>">Allow port</button>
            <% end %>
          <% end %>
        </td>
        <td class="px-2 py-1.5"><%= seen_age %></td>
        <td class="px-2 py-1.5 max-w-[260px] truncate" title="<%= host&.rdns_name.to_s %>"><%= host&.rdns_name || "--" %></td>
        <td class="px-2 py-1.5 max-w-[260px] truncate" title="<%= host&.try(:whois_raw_line).to_s %>"><%= host&.whois_name || "--" %></td>
        <td class="px-2 py-1.5">
          <% if seen_label == "NEW" %>
            <%= render "shared/badge", text: "NEW", variant: "info" %>
          <% else %>
            <%= render "shared/badge", text: "SEEN", variant: "neutral" %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
<% end %>

<script>
  (function() {
    const body = document.getElementById("connections-body");
    if (!body) return;

    function renderRow(conn) {
      const src = conn.src_port
        ? `<a href="/remote_hosts/${conn.src_ip}">${conn.src_ip}</a>:${conn.src_port}`
        : `<a href="/remote_hosts/${conn.src_ip}">${conn.src_ip}</a>`;
      const dst = conn.dst_port
        ? `<a href="/remote_hosts/${conn.dst_ip}">${conn.dst_ip}</a>:${conn.dst_port}`
        : `<a href="/remote_hosts/${conn.dst_ip}">${conn.dst_ip}</a>`;
      const seenLabel = conn.is_new ? "NEW" : "SEEN";
      const score = Number(conn.anomaly_score || 0);
      const scoreVariant = score >= 70 ? "alert" : (score >= 50 ? "warn" : (score >= 20 ? "info" : "neutral"));
      const scoreClass = scoreVariant === "alert"
        ? "bg-red-950/30 text-red-200 border border-red-800/40"
        : (scoreVariant === "warn"
          ? "bg-amber-950/30 text-amber-200 border border-amber-800/40"
          : (scoreVariant === "info"
            ? "bg-cyan-950/30 text-cyan-200 border border-cyan-800/40"
            : "bg-zinc-900/60 text-zinc-200 border border-zinc-700"));
      const reasons = (conn.anomaly_reasons || []).join(",");
      const allowButton = (conn.device_id && conn.dst_port)
        ? `<button type="button" class="allow-port-btn bg-cyan-600/15 text-cyan-200 border border-cyan-700/40 hover:bg-cyan-600/25 rounded-lg px-2 py-0.5 text-xs" data-device-id="${conn.device_id}" data-port="${conn.dst_port}">Allow port</button>`
        : "";
      const deviceCell = conn.device_id
        ? `<input class="device-name-input bg-black border border-zinc-800 rounded-lg px-2 py-1 text-zinc-200 placeholder:text-zinc-600 text-xs" data-device-id="${conn.device_id}" value="${conn.device_name || ""}" size="12">`
        : `<span>${conn.device_name || conn.src_ip}</span>`;
      const seenBadge = seenLabel === "NEW"
        ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-cyan-950/30 text-cyan-200 border border-cyan-800/40">NEW</span>`
        : `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-zinc-900/60 text-zinc-200 border border-zinc-700">SEEN</span>`;
      return `
        <tr class="odd:bg-black even:bg-zinc-950/30 hover:bg-zinc-900/50">
          <td class="px-2 py-1.5 font-mono text-xs">${conn.proto}</td>
          <td class="px-2 py-1.5">${deviceCell}</td>
          <td class="px-2 py-1.5">${src}</td>
          <td class="px-2 py-1.5">${dst}</td>
          <td class="px-2 py-1.5 font-mono text-xs">${conn.state || ""}</td>
          <td class="px-2 py-1.5 font-mono text-xs">${conn.flags || ""}</td>
          <td class="px-2 py-1.5 text-right">${conn.uplink_bytes}</td>
          <td class="px-2 py-1.5 text-right">${conn.downlink_bytes}</td>
          <td class="px-2 py-1.5 text-right">${conn.total_bytes}</td>
          <td class="px-2 py-1.5"><span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ${scoreClass}">${score}</span></td>
          <td class="px-2 py-1.5 max-w-[260px] truncate" title="${reasons}">${reasons}</td>
          <td class="px-2 py-1.5">${allowButton}</td>
          <td class="px-2 py-1.5">${conn.seen_age || "unknown"}</td>
          <td class="px-2 py-1.5 max-w-[260px] truncate" title="${conn.rdns_name || ""}">${conn.rdns_name || "--"}</td>
          <td class="px-2 py-1.5 max-w-[260px] truncate" title="${conn.whois_raw_line || ""}">${conn.whois_name || "--"}</td>
          <td class="px-2 py-1.5">${seenBadge}</td>
        </tr>
      `;
    }

    function buildConnectionsQuery() {
      const params = new URLSearchParams();
      const form = document.getElementById("connections-filter");
      if (!form) return "";
      const src = form.querySelector("input[name='src_ip']")?.value.trim();
      const dst = form.querySelector("input[name='dst_ip']")?.value.trim();
      const dport = form.querySelector("input[name='dport']")?.value.trim();
      const proto = form.querySelector("input[name='proto']")?.value.trim();
      const hide = form.querySelector("input[name='hide_time_wait']")?.checked;
      const onlyNew = form.querySelector("input[name='only_new']")?.checked;
      const minScore = form.querySelector("select[name='min_score']")?.value;

      if (src) params.set("src_ip", src);
      if (dst) params.set("dst_ip", dst);
      if (dport) params.set("dport", dport);
      if (proto) params.set("proto", proto);
      if (hide) params.set("hide_time_wait", "true");
      if (onlyNew) params.set("only_new", "true");
      if (minScore) params.set("min_score", minScore);

      const query = params.toString();
      return query ? `?${query}` : "";
    }

    function refresh() {
      if (document.activeElement && document.activeElement.classList.contains("device-name-input")) {
        return;
      }
      const query = buildConnectionsQuery();
      fetch(`/connections.json${query}`)
        .then((resp) => resp.json())
        .then((data) => {
          body.innerHTML = data.map(renderRow).join("");
        })
        .catch(() => {});
    }

    refresh();
    setInterval(refresh, 1000);

    const csrfToken = document.querySelector("meta[name='csrf-token']")?.content;
    let pendingSave = null;

    function saveDeviceName(input) {
      const deviceId = input.dataset.deviceId;
      if (!deviceId) return;
      if (!csrfToken) return;

      const name = input.value.trim();
      if (pendingSave) clearTimeout(pendingSave);
      pendingSave = setTimeout(() => {
        fetch(`/devices/${deviceId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": csrfToken,
            "Accept": "application/json"
          },
          body: JSON.stringify({ device: { name } })
        }).catch(() => {});
      }, 200);
    }

    body.addEventListener("change", (event) => {
      const target = event.target;
      if (target && target.classList.contains("device-name-input")) {
        saveDeviceName(target);
      }
    });

    body.addEventListener("keydown", (event) => {
      const target = event.target;
      if (!target || !target.classList.contains("device-name-input")) return;
      if (event.key === "Enter") {
        event.preventDefault();
        target.blur();
      }
    });

    body.addEventListener("click", (event) => {
      const target = event.target;
      if (!target || !target.classList.contains("allow-port-btn")) return;
      const deviceId = target.dataset.deviceId;
      const port = target.dataset.port;
      if (!deviceId || !port || !csrfToken) return;
      fetch("/allowlist_rules", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken,
          "Accept": "application/json"
        },
        body: JSON.stringify({ allowlist_rule: { kind: "device_port", value: port, device_id: deviceId } })
      }).catch(() => {});
    });

    const loadavgEl = document.getElementById("metric-loadavg");
    const collectorEl = document.getElementById("metric-collector");
    const memEl = document.getElementById("metric-mem");
    const ifacesEl = document.getElementById("metric-ifaces");
    const interfacesInput = document.getElementById("metric-interfaces");
    const newDstEl = document.getElementById("metric-new-dst");
    const uniqueDportsEl = document.getElementById("metric-unique-dports");
    const uplinkBytesEl = document.getElementById("metric-uplink-bytes");
    const newAsnsEl = document.getElementById("metric-new-asns");
    const anomaliesEl = document.getElementById("metric-anomalies");
    const detailEl = document.getElementById("metric-detail");
    const detailTitleEl = document.getElementById("metric-detail-title");
    const detailBodyEl = document.getElementById("metric-detail-body");
    const rarePortsList = document.getElementById("panel-rare-ports");

    let lastAnalytics = null;

    function renderHostList(hosts) {
      if (!hosts || hosts.length === 0) return "<div class=\"text-sm text-zinc-200\">None</div>";
      return hosts.map((host) => {
        const whois = host.whois || "--";
        const rdns = host.rdns || "--";
        const title = host.whois_raw || "";
        return `<div class="text-sm text-zinc-200 mb-1" title="${title}">${host.ip} — rDNS: ${rdns} — WHOIS: ${whois}</div>`;
      }).join("");
    }

    function showDetail(title, html) {
      if (!detailEl) return;
      detailTitleEl.textContent = title;
      detailBodyEl.innerHTML = html;
      detailEl.classList.remove("hidden");
    }

    const graphs = {
      newDst: { canvas: document.getElementById("graph-new-dst"), color: "#22d3ee" },
      uniqueDports: { canvas: document.getElementById("graph-unique-dports"), color: "#38bdf8" },
      uplinkBytes: { canvas: document.getElementById("graph-uplink-bytes"), color: "#34d399" },
      newAsns: { canvas: document.getElementById("graph-new-asns"), color: "#5eead4" }
    };

    const graphSeriesState = {};

    function drawLineWithScale(canvas, points, color) {
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const width = canvas.width = canvas.clientWidth;
      const height = canvas.height = canvas.clientHeight;
      ctx.clearRect(0, 0, width, height);

      if (!points || points.length === 0) {
        ctx.fillStyle = "#71717a";
        ctx.font = "12px sans-serif";
        ctx.fillText("No data yet", 10, 20);
        return;
      }

      const min = Math.min(...points);
      const max = Math.max(...points);
      const range = max - min || 1;

      const leftPad = 28;
      const rightPad = 6;
      const topPad = 6;
      const bottomPad = 12;
      const plotWidth = width - leftPad - rightPad;
      const plotHeight = height - topPad - bottomPad;

      ctx.strokeStyle = "#3f3f46";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(leftPad, topPad);
      ctx.lineTo(leftPad, topPad + plotHeight);
      ctx.lineTo(leftPad + plotWidth, topPad + plotHeight);
      ctx.stroke();

      ctx.fillStyle = "#71717a";
      ctx.font = "10px sans-serif";
      ctx.fillText(String(max), 2, topPad + 8);
      ctx.fillText(String(min), 2, topPad + plotHeight);

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((val, idx) => {
        const x = leftPad + (idx / (points.length - 1 || 1)) * plotWidth;
        const y = topPad + plotHeight - ((val - min) / range) * plotHeight;
        if (idx === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    function renderMetrics(payload) {
      if (loadavgEl && payload.loadavg) {
        const { one, five, fifteen } = payload.loadavg;
        loadavgEl.textContent = `${one ?? "--"} / ${five ?? "--"} / ${fifteen ?? "--"}`;
      }
      if (collectorEl) {
        const age = payload.collector?.age_seconds;
        if (age == null) {
          collectorEl.textContent = "Unknown";
          collectorEl.className = "text-zinc-200";
        } else {
          const statusClass = age <= 10 ? "text-emerald-300" : "text-red-300";
          const label = age <= 10 ? "OK" : "Stale";
          collectorEl.textContent = `${label} (${age}s ago)`;
          collectorEl.className = statusClass;
        }
      }
      if (memEl && payload.meminfo) {
        const total = payload.meminfo.total_kb || 0;
        const avail = payload.meminfo.available_kb || 0;
        const used = total - avail;
        memEl.textContent = `${used}k / ${total}k`;
      }
      if (ifacesEl) {
        const lines = (payload.interfaces || []).map((iface) => {
          return `${iface.name}: rx ${iface.rx_bytes ?? 0}, tx ${iface.tx_bytes ?? 0}`;
        });
        ifacesEl.textContent = lines.length > 0 ? lines.join(" | ") : "--";
      }

      if (payload.analytics) {
        lastAnalytics = payload.analytics;
        if (newDstEl) newDstEl.textContent = payload.analytics.new_dst_ips_last_10m ?? "--";
        if (uniqueDportsEl) uniqueDportsEl.textContent = payload.analytics.unique_dports_last_10m ?? "--";
        if (uplinkBytesEl) uplinkBytesEl.textContent = payload.analytics.uplink_bytes_last_10m ?? "--";
        if (newAsnsEl) newAsnsEl.textContent = payload.analytics.new_asns_last_1h ?? "--";

        if (anomaliesEl) {
          const list = (payload.analytics.anomalies || []).map((a) => a.rule);
          const asns = payload.analytics.new_asns_list || [];
          const extra = asns.length > 0 ? ` | ASNs: ${asns.join(", ")}` : "";
          anomaliesEl.textContent = list.length > 0 ? `${list.join("; ")}${extra}` : "None";
        }
      }

      // Graphs are updated via /metrics/series to respect per-graph time windows.
    }

    if (newDstEl) {
      newDstEl.addEventListener("click", () => {
        const hosts = lastAnalytics?.new_dst_hosts || [];
        showDetail("New DST IPs (10m)", renderHostList(hosts));
      });
    }

    if (uniqueDportsEl) {
      uniqueDportsEl.addEventListener("click", () => {
        const ports = lastAnalytics?.unique_dports_hosts || [];
        const html = ports.map((row) => {
          return `<div class="text-sm text-cyan-200 mb-1"><strong>Port ${row.port} (${row.count})</strong></div>${renderHostList(row.hosts)}`;
        }).join("");
        showDetail("Unique DPorts (10m)", html || "<div class=\"text-sm text-zinc-200\">None</div>");
      });
    }

    if (newAsnsEl) {
      newAsnsEl.addEventListener("click", () => {
        const asns = lastAnalytics?.new_asns_hosts || [];
        const html = asns.map((row) => {
          return `<div class="text-sm text-cyan-200 mb-1"><strong>${row.asn}</strong></div>${renderHostList(row.hosts)}`;
        }).join("");
        showDetail("New ASNs (1h)", html || "<div class=\"text-sm text-zinc-200\">None</div>");
      });
    }

    if (rarePortsList) {
      rarePortsList.addEventListener("click", (event) => {
        const target = event.target;
        if (!target || !target.classList.contains("rare-port-item")) return;
        const port = target.dataset.port;
        const ports = lastAnalytics?.rare_ports_hosts || [];
        if (port === "all") {
          const html = ports.map((row) => {
            return `<div class="text-sm text-cyan-200 mb-1"><strong>Port ${row.port} (${row.count})</strong></div>${renderHostList(row.hosts)}`;
          }).join("");
          showDetail("Rare Ports (24h)", html || "<div class=\"text-sm text-zinc-200\">None</div>");
          return;
        }
        const row = ports.find((item) => String(item.port) === port);
        if (!row) return;
        const html = `<div class="text-sm text-cyan-200 mb-1"><strong>Port ${row.port} (${row.count})</strong></div>${renderHostList(row.hosts)}`;
        showDetail(`Rare Port ${row.port} (24h)`, html);
      });
    }

    function refreshMetrics() {
      const interfaces = interfacesInput ? interfacesInput.value.trim() : "";
      const query = interfaces ? `?interfaces=${encodeURIComponent(interfaces)}` : "";
      fetch(`/metrics.json${query}`)
        .then((resp) => resp.json())
        .then(renderMetrics)
        .catch(() => {});
    }

    refreshMetrics();
    setInterval(refreshMetrics, 2000);

    if (interfacesInput) {
      let metricsTimer = null;
      interfacesInput.addEventListener("input", () => {
        clearTimeout(metricsTimer);
        metricsTimer = setTimeout(refreshMetrics, 200);
      });
    }

    function refreshGraphSeries() {
      document.querySelectorAll(".graph-window").forEach((select) => {
        const seriesKey = select.dataset.series;
        const window = select.value;
        fetchSeries(window).then((series) => {
          const points = series[seriesKey] || [];
          const canvas = document.querySelector(`canvas[data-series="${seriesKey}"]`);
          updateGraph(canvas, seriesKey, points, window);
        }).catch(() => {});
      });
    }

    refreshGraphSeries();
    setInterval(refreshGraphSeries, 10000);


    function seriesKeyFromCanvas(canvas) {
      return canvas?.dataset.series;
    }

    function fetchSeries(window) {
      return fetch(`/metrics/series.json?window=${encodeURIComponent(window)}`)
        .then((resp) => resp.json());
    }

    function updateGraph(canvas, seriesKey, points, windowLabel) {
      const color = Object.values(graphs).find((g) => g.canvas === canvas)?.color || "#36c";
      drawLineWithScale(canvas, points || [], color);
      graphSeriesState[seriesKey] = { points: points || [], window: windowLabel };
    }

    document.querySelectorAll(".graph-window").forEach((select) => {
      select.addEventListener("change", () => {
        const window = select.value;
        const seriesKey = select.dataset.series;
        if (graphSeriesState[seriesKey]) {
          graphSeriesState[seriesKey].window = window;
        } else {
          graphSeriesState[seriesKey] = { points: [], window: window };
        }
        fetchSeries(window).then((series) => {
          const points = series[seriesKey] || [];
          const canvas = document.querySelector(`canvas[data-series="${seriesKey}"]`);
          const color = Object.values(graphs).find((g) => g.canvas === canvas)?.color || "#36c";
          if (canvas) canvas.dataset.color = color;
          updateGraph(canvas, seriesKey, points, window);
        }).catch(() => {});
      });
    });

    window.addEventListener("popstate", refreshGraphSeries);

    Object.values(graphs).forEach((graph) => {
      if (!graph.canvas) return;
      graph.canvas.addEventListener("click", () => {
        const seriesKey = seriesKeyFromCanvas(graph.canvas);
        const state = graphSeriesState[seriesKey];
        if (!state || state.points.length === 0) return;
        const points = state.points;
        const min = Math.min(...points);
        const max = Math.max(...points);
        const last = points[points.length - 1];
        const title = `${seriesKey.replace(/_/g, " ")} (${state.window || "10m"})`;
        const html = `<div class="text-sm text-zinc-200 mb-1">Min: ${min}</div><div class="text-sm text-zinc-200 mb-1">Max: ${max}</div><div class="text-sm text-zinc-200 mb-1">Last: ${last}</div><div class="text-sm text-zinc-200">Points: ${points.length}</div>`;
        showDetail(title, html);
      });
    });

    const topRemoteHostsEl = document.getElementById("panel-top-remote-hosts");
    const newestRemoteHostsEl = document.getElementById("panel-newest-remote-hosts");
    const newestViewAllEl = document.getElementById("panel-newest-viewall");
    const rarePortsEl = document.getElementById("panel-rare-ports");
    const topDevicesEgressEl = document.getElementById("panel-top-devices-egress");
    const recentIncidentsEl = document.getElementById("panel-recent-incidents");

    function renderPanelList(el, items) {
      if (!el) return;
      el.innerHTML = items.map((item) => `<li>${item}</li>`).join("");
    }

    function refreshTopPanels() {
      const panelParams = new URLSearchParams();
      let newestWindow = "10m";
      document.querySelectorAll(".panel-window").forEach((select) => {
        const panel = select.dataset.panel;
        if (panel === "top-remote") panelParams.set("top_remote_window", select.value);
        if (panel === "newest") {
          panelParams.set("newest_window", select.value);
          newestWindow = select.value;
        }
        if (panel === "rare") panelParams.set("rare_window", select.value);
        if (panel === "devices-egress") panelParams.set("top_devices_window", select.value);
      });
      const query = panelParams.toString();
      const url = query ? `/dashboard/top_panels.json?${query}` : "/dashboard/top_panels.json";
      fetch(url)
        .then((resp) => resp.json())
        .then((data) => {
          const topRemote = (data.top_remote_hosts || []).map((row) => {
            return `<a href="/remote_hosts/${row.ip}">${row.ip}</a> (${row.total_bytes} bytes)`;
          });
          const newest = (data.newest_remote_hosts || []).map((row) => {
            const label = `${row.ip}${row.port ? `:${row.port}` : ""}`;
            return `<a href="/remote_hosts/${row.ip}">${label}</a>`;
          });
          const topDevices = (data.top_devices_egress || []).map((row) => `${row.label} (${row.total_uplink} bytes)`);
          renderPanelList(topRemoteHostsEl, topRemote);
          renderPanelList(newestRemoteHostsEl, newest);
          if (newestViewAllEl) {
            newestViewAllEl.setAttribute("href", `/remote_hosts?window=${encodeURIComponent(newestWindow)}`);
          }
          renderPanelList(topDevicesEgressEl, topDevices);

          if (rarePortsEl) {
            const rows = (data.rare_ports || []).filter((row) => row && row.port != null);
            const items = rows.map((row) => {
              const ipSnippet = (row.ips || []).slice(0, 2).join(", ");
              const suffix = ipSnippet ? ` — ${ipSnippet}` : "";
              return `<button type="button" class="rare-port-item text-cyan-200 hover:text-cyan-100 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black rounded" data-port="${row.port}">${row.port} (${row.count})${suffix}</button>`;
            });
            const allItem = `<button type="button" class="rare-port-item text-cyan-200 hover:text-cyan-100 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black rounded" data-port="all">View All</button>`;
            rarePortsEl.innerHTML = [allItem, ...items].map((item) => `<li>${item}</li>`).join("");
          }

          if (recentIncidentsEl) {
            const incidents = (data.recent_incidents || []).map((incident) => {
              const dst = incident.dst_ip ? `${incident.dst_ip}${incident.dst_port ? `:${incident.dst_port}` : ""}` : "device-level";
              const device = incident.device ? `${incident.device}` : "";
              const codes = incident.codes ? ` ${incident.codes}` : "";
              const count = incident.count ? ` x${incident.count}` : "";
              return `<a href="/incidents/${incident.id}">${device} ${dst} (${incident.max_score})${codes}${count}</a>`;
            });
            renderPanelList(recentIncidentsEl, incidents);
          }
        })
        .catch(() => {});
    }

    refreshTopPanels();
    setInterval(refreshTopPanels, 2000);

    document.querySelectorAll(".panel-window").forEach((select) => {
      select.addEventListener("change", refreshTopPanels);
    });
  })();
</script>
