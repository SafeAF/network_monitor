<style>
  table.netmon-table {
    border-collapse: collapse;
    width: 100%;
  }
  table.netmon-table th,
  table.netmon-table td {
    padding: 6px 8px;
    text-align: left;
    white-space: nowrap;
  }
  table.netmon-table thead th {
    border-bottom: 1px solid #ddd;
  }
  .netmon-score {
    display: inline-block;
    min-width: 32px;
    text-align: center;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    background: #f2f2f2;
    color: #333;
  }
  .netmon-score.high {
    background: #ffebe8;
    color: #8a0a0a;
  }
  .netmon-score.med {
    background: #fff7e0;
    color: #8a5b0a;
  }
  .netmon-score.low {
    background: #e6f4ff;
    color: #0a4a8a;
  }
  .netmon-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }
  .netmon-badge.new {
    background: #e6f4ff;
    color: #0a4a8a;
  }
  .netmon-badge.seen {
    background: #f2f2f2;
    color: #333;
  }
  .netmon-filters {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 8px 0 16px;
    align-items: center;
  }
  .netmon-filters label {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .netmon-tiles {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin: 12px 0 16px;
  }
  .netmon-tile {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px 12px;
  }
  .netmon-tile h3 {
    margin: 0 0 6px;
    font-size: 14px;
  }
  .netmon-tile .value {
    font-size: 16px;
    font-weight: 600;
  }
  .netmon-tile button {
    all: unset;
    cursor: pointer;
    display: inline-block;
  }
  .netmon-graphs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 12px;
    margin: 12px 0 16px;
  }
  .netmon-graph {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px 12px;
  }
  .netmon-graph canvas {
    width: 100%;
    height: 120px;
  }
  .netmon-graph .graph-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }
  .netmon-graph select {
    font-size: 12px;
  }
  .netmon-anomalies {
    border: 1px solid #f0c36d;
    background: #fff7e0;
    padding: 10px 12px;
    border-radius: 6px;
    margin: 12px 0 16px;
  }
  .netmon-detail {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px 12px;
    margin: 12px 0 16px;
  }
  .netmon-detail h3 {
    margin: 0 0 8px;
    font-size: 14px;
  }
  .netmon-detail .item {
    margin: 4px 0;
  }
  .netmon-top-panels {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
    margin: 12px 0 16px;
  }
  .netmon-panel {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px 12px;
  }
  .netmon-panel h3 {
    margin: 0 0 6px;
    font-size: 14px;
  }
  .netmon-panel select {
    font-size: 12px;
    margin-bottom: 6px;
  }
  .netmon-panel .rare-port-item {
    all: unset;
    cursor: pointer;
    color: inherit;
    display: inline-block;
  }
  .netmon-panel .rare-port-item:focus {
    outline: 2px solid #9ec3ff;
    outline-offset: 2px;
  }
</style>

<h1>Active Connections</h1>

<form class="netmon-filters" method="get">
  <label>
    Src IP
    <input name="src_ip" value="<%= params[:src_ip].to_s %>">
  </label>
  <label>
    Dst IP
    <input name="dst_ip" value="<%= params[:dst_ip].to_s %>">
  </label>
  <label>
    Dst Port
    <input name="dport" value="<%= params[:dport].to_s %>">
  </label>
  <label>
    Proto
    <input name="proto" value="<%= params[:proto].to_s %>">
  </label>
  <label>
    <input type="checkbox" name="hide_time_wait" value="true" <%= "checked" if params[:hide_time_wait].present? %>>
    Hide TIME_WAIT
  </label>
  <label>
    <input type="checkbox" name="only_new" value="true" <%= "checked" if params[:only_new].present? %>>
    Only NEW
  </label>
  <label>
    Min Score
    <select name="min_score">
      <option value="" <%= "selected" if params[:min_score].to_s.empty? %>>All</option>
      <option value="0" <%= "selected" if params[:min_score] == "0" %>>0</option>
      <option value="20" <%= "selected" if params[:min_score] == "20" %>>20</option>
      <option value="50" <%= "selected" if params[:min_score] == "50" %>>50</option>
    </select>
  </label>
  <label>
    Interfaces
    <input id="metric-interfaces" name="interfaces" value="<%= params[:interfaces].to_s %>" list="interface-options">
    <datalist id="interface-options">
      <option value="enp42s0"></option>
      <option value="enp2s0"></option>
      <option value="enp3s0"></option>
    </datalist>
  </label>
  <button type="submit">Apply</button>
  <a href="/">Clear</a>
  <a href="?only_new=true">Only NEW</a>
  <a href="?hide_time_wait=true">Hide TIME_WAIT</a>
  <a href="?min_score=0">Score 0+</a>
  <a href="?min_score=20">Score 20+</a>
  <a href="?min_score=50">Score 50+</a>
  <a href="/devices">Edit Devices</a>
  <a href="/anomalies">Anomalies</a>
  <a href="/search">Search</a>
  <a href="/remote_hosts">Remote Hosts</a>
</form>

<section class="netmon-tiles">
  <div class="netmon-tile">
    <h3>Load Avg</h3>
    <div class="value" id="metric-loadavg">--</div>
  </div>
  <div class="netmon-tile">
    <h3>Memory</h3>
    <div class="value" id="metric-mem">--</div>
  </div>
  <div class="netmon-tile">
    <h3>Interfaces</h3>
    <div class="value" id="metric-ifaces">--</div>
  </div>
  <div class="netmon-tile">
    <h3>New DST IPs (10m)</h3>
    <div class="value"><button type="button" id="metric-new-dst">--</button></div>
  </div>
  <div class="netmon-tile">
    <h3>Unique DPorts (10m)</h3>
    <div class="value"><button type="button" id="metric-unique-dports">--</button></div>
  </div>
  <div class="netmon-tile">
    <h3>Uplink Bytes (10m)</h3>
    <div class="value" id="metric-uplink-bytes">--</div>
  </div>
  <div class="netmon-tile">
    <h3>New ASNs (1h)</h3>
    <div class="value"><button type="button" id="metric-new-asns">--</button></div>
  </div>
</section>

<section class="netmon-detail" id="metric-detail" style="display: none;">
  <h3 id="metric-detail-title"></h3>
  <div id="metric-detail-body"></div>
</section>

<section class="netmon-graphs">
  <div class="netmon-graph">
    <div class="graph-header">
      <h3>New DST IPs</h3>
      <select class="graph-window" data-series="new_dst_ips_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-new-dst" data-series="new_dst_ips_last_10m"></canvas>
  </div>
  <div class="netmon-graph">
    <div class="graph-header">
      <h3>Unique DPorts</h3>
      <select class="graph-window" data-series="unique_dports_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-unique-dports" data-series="unique_dports_last_10m"></canvas>
  </div>
  <div class="netmon-graph">
    <div class="graph-header">
      <h3>Uplink Bytes</h3>
      <select class="graph-window" data-series="uplink_bytes_last_10m">
        <option value="10m" selected>10m</option>
        <option value="1h">1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-uplink-bytes" data-series="uplink_bytes_last_10m"></canvas>
  </div>
  <div class="netmon-graph">
    <div class="graph-header">
      <h3>New ASNs</h3>
      <select class="graph-window" data-series="new_asns_last_1h">
        <option value="10m">10m</option>
        <option value="1h" selected>1h</option>
        <option value="24h">24h</option>
        <option value="1w">1w</option>
      </select>
    </div>
    <canvas id="graph-new-asns" data-series="new_asns_last_1h"></canvas>
  </div>
</section>

<section class="netmon-anomalies">
  <strong>Anomalies:</strong>
  <span id="metric-anomalies">None</span>
</section>

<section class="netmon-top-panels">
  <div class="netmon-panel">
    <h3>Top Remote Hosts (10m)</h3>
    <select class="panel-window" data-panel="top-remote" data-default="10m">
      <option value="10m" selected>10m</option>
      <option value="1h">1h</option>
      <option value="24h">24h</option>
      <option value="1w">1w</option>
    </select>
    <ol id="panel-top-remote-hosts">
      <% @top_remote_hosts.each do |row| %>
        <li><a href="/remote_hosts/<%= row[:ip] %>"><%= row[:ip] %></a> (<%= row[:total_bytes].to_i %> bytes)</li>
      <% end %>
    </ol>
  </div>
  <div class="netmon-panel">
    <h3>Newest Remote Hosts (10m) <a id="panel-newest-viewall" href="/remote_hosts?window=10m">View All</a></h3>
    <select class="panel-window" data-panel="newest" data-default="10m">
      <option value="10m" selected>10m</option>
      <option value="1h">1h</option>
      <option value="24h">24h</option>
      <option value="1w">1w</option>
    </select>
    <ol id="panel-newest-remote-hosts">
      <% @newest_remote_hosts.each do |host| %>
        <li><a href="/remote_hosts/<%= host[:ip] %>"><%= host[:ip] %><%= host[:port] ? ":#{host[:port]}" : "" %></a></li>
      <% end %>
    </ol>
  </div>
  <div class="netmon-panel">
    <h3>Rare Ports (24h)</h3>
    <select class="panel-window" data-panel="rare" data-default="24h">
      <option value="10m">10m</option>
      <option value="1h">1h</option>
      <option value="24h" selected>24h</option>
      <option value="1w">1w</option>
    </select>
    <ol id="panel-rare-ports">
      <li><button type="button" class="rare-port-item" data-port="all">View All</button></li>
      <% @rare_ports.each do |row| %>
        <% ip_snippet = row[:ips].to_a.first(2).join(", ") %>
        <% suffix = ip_snippet.present? ? " — #{ip_snippet}" : "" %>
        <li><button type="button" class="rare-port-item" data-port="<%= row[:port] %>"><%= row[:port] %> (<%= row[:count] %>)<%= suffix %></button></li>
      <% end %>
    </ol>
  </div>
  <div class="netmon-panel">
    <h3>Devices by Egress (10m)</h3>
    <select class="panel-window" data-panel="devices-egress" data-default="10m">
      <option value="10m" selected>10m</option>
      <option value="1h">1h</option>
      <option value="24h">24h</option>
      <option value="1w">1w</option>
    </select>
    <ol id="panel-top-devices-egress">
      <% @top_devices_egress.each do |row| %>
        <li><%= row[:label] %> (<%= row[:total_uplink].to_i %> bytes)</li>
      <% end %>
    </ol>
  </div>
</section>

<table class="netmon-table">
  <thead>
    <tr>
      <th>Proto</th>
      <th>Device</th>
      <th>Source</th>
      <th>Destination</th>
      <th>State</th>
      <th>Flags</th>
      <th>Up (bytes)</th>
      <th>Down (bytes)</th>
      <th>Total (bytes)</th>
      <th>Score</th>
      <th>Reasons</th>
      <th>Allow</th>
      <th>Age</th>
      <th>rDNS</th>
      <th>WHOIS</th>
      <th>Seen</th>
    </tr>
  </thead>
  <tbody id="connections-body">
    <% @connections.each do |conn| %>
      <% host = @hosts_by_ip[conn.dst_ip] %>
      <% device = @devices_by_ip[conn.src_ip] %>
      <% seen_label = host&.new? ? "NEW" : "SEEN" %>
      <% seen_age = host&.seen_age || "unknown" %>
      <% device_label = device&.name.presence || conn.src_ip %>
      <% reasons = begin
           JSON.parse(conn.anomaly_reasons_json || "[]")
         rescue JSON::ParserError
           []
         end %>
      <% reason_codes = reasons.map { |reason| reason["code"] }.compact %>
      <tr>
        <td><%= conn.proto %></td>
        <td>
          <% if device %>
            <input class="device-name-input" data-device-id="<%= device.id %>" value="<%= device.name %>" size="14">
          <% else %>
            <%= device_label %>
          <% end %>
        </td>
        <td><a href="/remote_hosts/<%= conn.src_ip %>"><%= conn.src_ip %></a>:<%= conn.src_port %></td>
        <td><a href="/remote_hosts/<%= conn.dst_ip %>"><%= conn.dst_ip %></a>:<%= conn.dst_port %></td>
        <td><%= conn.state %></td>
        <td><%= conn.flags %></td>
        <td><%= conn.uplink_bytes %></td>
        <td><%= conn.downlink_bytes %></td>
        <td><%= conn.uplink_bytes + conn.downlink_bytes %></td>
        <td>
          <% score_class = conn.anomaly_score.to_i >= 50 ? "high" : (conn.anomaly_score.to_i >= 20 ? "med" : "low") %>
          <span class="netmon-score <%= score_class %>"><%= conn.anomaly_score.to_i %></span>
        </td>
        <td><%= reason_codes.join(",") %></td>
        <td>
          <% if device && conn.dst_port %>
            <%= form_with url: "/allowlist_rules", method: :post, local: true do |form| %>
              <input type="hidden" name="allowlist_rule[kind]" value="device_port">
              <input type="hidden" name="allowlist_rule[value]" value="<%= conn.dst_port %>">
              <input type="hidden" name="allowlist_rule[device_id]" value="<%= device.id %>">
              <button type="submit">Allow port</button>
            <% end %>
          <% end %>
        </td>
        <td><%= seen_age %></td>
        <td><%= host&.rdns_name || "--" %></td>
        <td title="<%= host&.try(:whois_raw_line).to_s %>"><%= host&.whois_name || "--" %></td>
        <td><span class="netmon-badge <%= seen_label.downcase %>"><%= seen_label %></span></td>
      </tr>
    <% end %>
  </tbody>
</table>

<script>
  (function() {
    const body = document.getElementById("connections-body");
    if (!body) return;

    function renderRow(conn) {
      const src = conn.src_port
        ? `<a href="/remote_hosts/${conn.src_ip}">${conn.src_ip}</a>:${conn.src_port}`
        : `<a href="/remote_hosts/${conn.src_ip}">${conn.src_ip}</a>`;
      const dst = conn.dst_port
        ? `<a href="/remote_hosts/${conn.dst_ip}">${conn.dst_ip}</a>:${conn.dst_port}`
        : `<a href="/remote_hosts/${conn.dst_ip}">${conn.dst_ip}</a>`;
      const seenLabel = conn.is_new ? "NEW" : "SEEN";
      const seenClass = conn.is_new ? "new" : "seen";
      const score = Number(conn.anomaly_score || 0);
      const scoreClass = score >= 50 ? "high" : (score >= 20 ? "med" : "low");
      const reasons = (conn.anomaly_reasons || []).join(",");
      const allowButton = (conn.device_id && conn.dst_port)
        ? `<button type="button" class="allow-port-btn" data-device-id="${conn.device_id}" data-port="${conn.dst_port}">Allow port</button>`
        : "";
      const deviceCell = conn.device_id
        ? `<input class="device-name-input" data-device-id="${conn.device_id}" value="${conn.device_name || ""}" size="14">`
        : `<span>${conn.device_name || conn.src_ip}</span>`;
      return `
        <tr>
          <td>${conn.proto}</td>
          <td>${deviceCell}</td>
          <td>${src}</td>
          <td>${dst}</td>
          <td>${conn.state || ""}</td>
          <td>${conn.flags || ""}</td>
          <td>${conn.uplink_bytes}</td>
          <td>${conn.downlink_bytes}</td>
          <td>${conn.total_bytes}</td>
          <td><span class="netmon-score ${scoreClass}">${score}</span></td>
          <td>${reasons}</td>
          <td>${allowButton}</td>
          <td>${conn.seen_age || "unknown"}</td>
          <td>${conn.rdns_name || "--"}</td>
          <td title="${conn.whois_raw_line || ""}">${conn.whois_name || "--"}</td>
          <td><span class="netmon-badge ${seenClass}">${seenLabel}</span></td>
        </tr>
      `;
    }

    function buildConnectionsQuery() {
      const params = new URLSearchParams(window.location.search || "");
      params.delete("interfaces");
      const query = params.toString();
      return query ? `?${query}` : "";
    }

    function refresh() {
      if (document.activeElement && document.activeElement.classList.contains("device-name-input")) {
        return;
      }
      const query = buildConnectionsQuery();
      fetch(`/connections.json${query}`)
        .then((resp) => resp.json())
        .then((data) => {
          body.innerHTML = data.map(renderRow).join("");
        })
        .catch(() => {});
    }

    refresh();
    setInterval(refresh, 1000);

    const csrfToken = document.querySelector("meta[name='csrf-token']")?.content;
    let pendingSave = null;

    function saveDeviceName(input) {
      const deviceId = input.dataset.deviceId;
      if (!deviceId) return;
      if (!csrfToken) return;

      const name = input.value.trim();
      if (pendingSave) clearTimeout(pendingSave);
      pendingSave = setTimeout(() => {
        fetch(`/devices/${deviceId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": csrfToken,
            "Accept": "application/json"
          },
          body: JSON.stringify({ device: { name } })
        }).catch(() => {});
      }, 200);
    }

    body.addEventListener("change", (event) => {
      const target = event.target;
      if (target && target.classList.contains("device-name-input")) {
        saveDeviceName(target);
      }
    });

    body.addEventListener("keydown", (event) => {
      const target = event.target;
      if (!target || !target.classList.contains("device-name-input")) return;
      if (event.key === "Enter") {
        event.preventDefault();
        target.blur();
      }
    });

    body.addEventListener("click", (event) => {
      const target = event.target;
      if (!target || !target.classList.contains("allow-port-btn")) return;
      const deviceId = target.dataset.deviceId;
      const port = target.dataset.port;
      if (!deviceId || !port || !csrfToken) return;
      fetch("/allowlist_rules", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken,
          "Accept": "application/json"
        },
        body: JSON.stringify({ allowlist_rule: { kind: "device_port", value: port, device_id: deviceId } })
      }).catch(() => {});
    });

    const loadavgEl = document.getElementById("metric-loadavg");
    const memEl = document.getElementById("metric-mem");
    const ifacesEl = document.getElementById("metric-ifaces");
    const interfacesInput = document.getElementById("metric-interfaces");
    const newDstEl = document.getElementById("metric-new-dst");
    const uniqueDportsEl = document.getElementById("metric-unique-dports");
    const uplinkBytesEl = document.getElementById("metric-uplink-bytes");
    const newAsnsEl = document.getElementById("metric-new-asns");
    const anomaliesEl = document.getElementById("metric-anomalies");
    const detailEl = document.getElementById("metric-detail");
    const detailTitleEl = document.getElementById("metric-detail-title");
    const detailBodyEl = document.getElementById("metric-detail-body");
    const rarePortsList = document.getElementById("panel-rare-ports");

    let lastAnalytics = null;

    function renderHostList(hosts) {
      if (!hosts || hosts.length === 0) return "<div class=\"item\">None</div>";
      return hosts.map((host) => {
        const whois = host.whois || "--";
        const rdns = host.rdns || "--";
        const title = host.whois_raw || "";
        return `<div class="item" title="${title}">${host.ip} — rDNS: ${rdns} — WHOIS: ${whois}</div>`;
      }).join("");
    }

    function showDetail(title, html) {
      if (!detailEl) return;
      detailTitleEl.textContent = title;
      detailBodyEl.innerHTML = html;
      detailEl.style.display = "block";
    }

    const graphs = {
      newDst: { canvas: document.getElementById("graph-new-dst"), color: "#2a7" },
      uniqueDports: { canvas: document.getElementById("graph-unique-dports"), color: "#b55" },
      uplinkBytes: { canvas: document.getElementById("graph-uplink-bytes"), color: "#36c" },
      newAsns: { canvas: document.getElementById("graph-new-asns"), color: "#884" }
    };

    const graphSeriesState = {};

    function drawLineWithScale(canvas, points, color) {
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const width = canvas.width = canvas.clientWidth;
      const height = canvas.height = canvas.clientHeight;
      ctx.clearRect(0, 0, width, height);

      if (!points || points.length === 0) {
        ctx.fillStyle = "#666";
        ctx.font = "12px sans-serif";
        ctx.fillText("No data yet", 10, 20);
        return;
      }

      const min = Math.min(...points);
      const max = Math.max(...points);
      const range = max - min || 1;

      const leftPad = 28;
      const rightPad = 6;
      const topPad = 6;
      const bottomPad = 12;
      const plotWidth = width - leftPad - rightPad;
      const plotHeight = height - topPad - bottomPad;

      ctx.strokeStyle = "#e0e0e0";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(leftPad, topPad);
      ctx.lineTo(leftPad, topPad + plotHeight);
      ctx.lineTo(leftPad + plotWidth, topPad + plotHeight);
      ctx.stroke();

      ctx.fillStyle = "#555";
      ctx.font = "10px sans-serif";
      ctx.fillText(String(max), 2, topPad + 8);
      ctx.fillText(String(min), 2, topPad + plotHeight);

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((val, idx) => {
        const x = leftPad + (idx / (points.length - 1 || 1)) * plotWidth;
        const y = topPad + plotHeight - ((val - min) / range) * plotHeight;
        if (idx === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    function renderMetrics(payload) {
      if (loadavgEl && payload.loadavg) {
        const { one, five, fifteen } = payload.loadavg;
        loadavgEl.textContent = `${one ?? "--"} / ${five ?? "--"} / ${fifteen ?? "--"}`;
      }
      if (memEl && payload.meminfo) {
        const total = payload.meminfo.total_kb || 0;
        const avail = payload.meminfo.available_kb || 0;
        const used = total - avail;
        memEl.textContent = `${used}k / ${total}k`;
      }
      if (ifacesEl) {
        const lines = (payload.interfaces || []).map((iface) => {
          return `${iface.name}: rx ${iface.rx_bytes ?? 0}, tx ${iface.tx_bytes ?? 0}`;
        });
        ifacesEl.textContent = lines.length > 0 ? lines.join(" | ") : "--";
      }

      if (payload.analytics) {
        lastAnalytics = payload.analytics;
        if (newDstEl) newDstEl.textContent = payload.analytics.new_dst_ips_last_10m ?? "--";
        if (uniqueDportsEl) uniqueDportsEl.textContent = payload.analytics.unique_dports_last_10m ?? "--";
        if (uplinkBytesEl) uplinkBytesEl.textContent = payload.analytics.uplink_bytes_last_10m ?? "--";
        if (newAsnsEl) newAsnsEl.textContent = payload.analytics.new_asns_last_1h ?? "--";

        if (anomaliesEl) {
          const list = (payload.analytics.anomalies || []).map((a) => a.rule);
          const asns = payload.analytics.new_asns_list || [];
          const extra = asns.length > 0 ? ` | ASNs: ${asns.join(", ")}` : "";
          anomaliesEl.textContent = list.length > 0 ? `${list.join("; ")}${extra}` : "None";
        }
      }

      // Graphs are updated via /metrics/series to respect per-graph time windows.
    }

    if (newDstEl) {
      newDstEl.addEventListener("click", () => {
        const hosts = lastAnalytics?.new_dst_hosts || [];
        showDetail("New DST IPs (10m)", renderHostList(hosts));
      });
    }

    if (uniqueDportsEl) {
      uniqueDportsEl.addEventListener("click", () => {
        const ports = lastAnalytics?.unique_dports_hosts || [];
        const html = ports.map((row) => {
          return `<div class="item"><strong>Port ${row.port} (${row.count})</strong></div>${renderHostList(row.hosts)}`;
        }).join("");
        showDetail("Unique DPorts (10m)", html || "<div class=\"item\">None</div>");
      });
    }

    if (newAsnsEl) {
      newAsnsEl.addEventListener("click", () => {
        const asns = lastAnalytics?.new_asns_hosts || [];
        const html = asns.map((row) => {
          return `<div class="item"><strong>${row.asn}</strong></div>${renderHostList(row.hosts)}`;
        }).join("");
        showDetail("New ASNs (1h)", html || "<div class=\"item\">None</div>");
      });
    }

    if (rarePortsList) {
      rarePortsList.addEventListener("click", (event) => {
        const target = event.target;
        if (!target || !target.classList.contains("rare-port-item")) return;
        const port = target.dataset.port;
        const ports = lastAnalytics?.rare_ports_hosts || [];
        if (port === "all") {
          const html = ports.map((row) => {
            return `<div class="item"><strong>Port ${row.port} (${row.count})</strong></div>${renderHostList(row.hosts)}`;
          }).join("");
          showDetail("Rare Ports (24h)", html || "<div class=\"item\">None</div>");
          return;
        }
        const row = ports.find((item) => String(item.port) === port);
        if (!row) return;
        const html = `<div class="item"><strong>Port ${row.port} (${row.count})</strong></div>${renderHostList(row.hosts)}`;
        showDetail(`Rare Port ${row.port} (24h)`, html);
      });
    }

    function refreshMetrics() {
      const interfaces = interfacesInput ? interfacesInput.value.trim() : "";
      const query = interfaces ? `?interfaces=${encodeURIComponent(interfaces)}` : "";
      fetch(`/metrics.json${query}`)
        .then((resp) => resp.json())
        .then(renderMetrics)
        .catch(() => {});
    }

    refreshMetrics();
    setInterval(refreshMetrics, 2000);

    if (interfacesInput) {
      let metricsTimer = null;
      interfacesInput.addEventListener("input", () => {
        clearTimeout(metricsTimer);
        metricsTimer = setTimeout(refreshMetrics, 200);
      });
    }

    function refreshGraphSeries() {
      document.querySelectorAll(".graph-window").forEach((select) => {
        const seriesKey = select.dataset.series;
        const window = select.value;
        fetchSeries(window).then((series) => {
          const points = series[seriesKey] || [];
          const canvas = document.querySelector(`canvas[data-series="${seriesKey}"]`);
          updateGraph(canvas, seriesKey, points, window);
        }).catch(() => {});
      });
    }

    refreshGraphSeries();
    setInterval(refreshGraphSeries, 10000);


    function seriesKeyFromCanvas(canvas) {
      return canvas?.dataset.series;
    }

    function fetchSeries(window) {
      return fetch(`/metrics/series.json?window=${encodeURIComponent(window)}`)
        .then((resp) => resp.json());
    }

    function updateGraph(canvas, seriesKey, points, windowLabel) {
      const color = Object.values(graphs).find((g) => g.canvas === canvas)?.color || "#36c";
      drawLineWithScale(canvas, points || [], color);
      graphSeriesState[seriesKey] = { points: points || [], window: windowLabel };
    }

    document.querySelectorAll(".graph-window").forEach((select) => {
      select.addEventListener("change", () => {
        const window = select.value;
        const seriesKey = select.dataset.series;
        if (graphSeriesState[seriesKey]) {
          graphSeriesState[seriesKey].window = window;
        } else {
          graphSeriesState[seriesKey] = { points: [], window: window };
        }
        fetchSeries(window).then((series) => {
          const points = series[seriesKey] || [];
          const canvas = document.querySelector(`canvas[data-series="${seriesKey}"]`);
          const color = Object.values(graphs).find((g) => g.canvas === canvas)?.color || "#36c";
          if (canvas) canvas.dataset.color = color;
          updateGraph(canvas, seriesKey, points, window);
        }).catch(() => {});
      });
    });

    window.addEventListener("popstate", refreshGraphSeries);

    Object.values(graphs).forEach((graph) => {
      if (!graph.canvas) return;
      graph.canvas.addEventListener("click", () => {
        const seriesKey = seriesKeyFromCanvas(graph.canvas);
        const state = graphSeriesState[seriesKey];
        if (!state || state.points.length === 0) return;
        const points = state.points;
        const min = Math.min(...points);
        const max = Math.max(...points);
        const last = points[points.length - 1];
        const title = `${seriesKey.replace(/_/g, " ")} (${state.window || "10m"})`;
        const html = `<div class="item">Min: ${min}</div><div class="item">Max: ${max}</div><div class="item">Last: ${last}</div><div class="item">Points: ${points.length}</div>`;
        showDetail(title, html);
      });
    });

    const topRemoteHostsEl = document.getElementById("panel-top-remote-hosts");
    const newestRemoteHostsEl = document.getElementById("panel-newest-remote-hosts");
    const newestViewAllEl = document.getElementById("panel-newest-viewall");
    const rarePortsEl = document.getElementById("panel-rare-ports");
    const topDevicesEgressEl = document.getElementById("panel-top-devices-egress");

    function renderPanelList(el, items) {
      if (!el) return;
      el.innerHTML = items.map((item) => `<li>${item}</li>`).join("");
    }

    function refreshTopPanels() {
      const panelParams = new URLSearchParams();
      let newestWindow = "10m";
      document.querySelectorAll(".panel-window").forEach((select) => {
        const panel = select.dataset.panel;
        if (panel === "top-remote") panelParams.set("top_remote_window", select.value);
        if (panel === "newest") {
          panelParams.set("newest_window", select.value);
          newestWindow = select.value;
        }
        if (panel === "rare") panelParams.set("rare_window", select.value);
        if (panel === "devices-egress") panelParams.set("top_devices_window", select.value);
      });
      const query = panelParams.toString();
      const url = query ? `/dashboard/top_panels.json?${query}` : "/dashboard/top_panels.json";
      fetch(url)
        .then((resp) => resp.json())
        .then((data) => {
          const topRemote = (data.top_remote_hosts || []).map((row) => {
            return `<a href="/remote_hosts/${row.ip}">${row.ip}</a> (${row.total_bytes} bytes)`;
          });
          const newest = (data.newest_remote_hosts || []).map((row) => {
            const label = `${row.ip}${row.port ? `:${row.port}` : ""}`;
            return `<a href="/remote_hosts/${row.ip}">${label}</a>`;
          });
          const topDevices = (data.top_devices_egress || []).map((row) => `${row.label} (${row.total_uplink} bytes)`);
          renderPanelList(topRemoteHostsEl, topRemote);
          renderPanelList(newestRemoteHostsEl, newest);
          if (newestViewAllEl) {
            newestViewAllEl.setAttribute("href", `/remote_hosts?window=${encodeURIComponent(newestWindow)}`);
          }
          renderPanelList(topDevicesEgressEl, topDevices);

          if (rarePortsEl) {
            const rows = (data.rare_ports || []).filter((row) => row && row.port != null);
            const items = rows.map((row) => {
              const ipSnippet = (row.ips || []).slice(0, 2).join(", ");
              const suffix = ipSnippet ? ` — ${ipSnippet}` : "";
              return `<button type="button" class="rare-port-item" data-port="${row.port}">${row.port} (${row.count})${suffix}</button>`;
            });
            const allItem = `<button type="button" class="rare-port-item" data-port="all">View All</button>`;
            rarePortsEl.innerHTML = [allItem, ...items].map((item) => `<li>${item}</li>`).join("");
          }
        })
        .catch(() => {});
    }

    refreshTopPanels();
    setInterval(refreshTopPanels, 2000);

    document.querySelectorAll(".panel-window").forEach((select) => {
      select.addEventListener("change", refreshTopPanels);
    });
  })();
</script>
