<% input_class = "bg-black border border-zinc-800 rounded-lg px-2 py-1 text-zinc-200 placeholder:text-zinc-600 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black" %>
<% checkbox_class = "rounded border-zinc-700 bg-black text-cyan-400 focus-visible:ring-2 focus-visible:ring-cyan-400/60 focus-visible:ring-offset-2 focus-visible:ring-offset-black" %>
<% button_primary = "bg-emerald-600/20 text-emerald-200 border border-emerald-700/40 hover:bg-emerald-600/30 rounded-lg px-3 py-1 text-sm" %>
<% button_neutral = "bg-zinc-900/50 text-zinc-200 border border-zinc-800 hover:bg-zinc-900/80 rounded-lg px-3 py-1 text-sm" %>

<h1 class="text-xl text-emerald-300 font-semibold tracking-wide mb-3">Incidents</h1>

<form method="get" class="mb-4">
  <%= render "shared/filter_bar", storage_key: "netmon.filterbar.incidents" do %>
    <label class="flex items-center gap-2 text-xs uppercase tracking-wider text-zinc-500 mt-4">
      <input type="checkbox" class="<%= checkbox_class %>" name="unacknowledged" value="true" <%= "checked" if @filters[:unacknowledged].to_s == "true" %>>
      Unacknowledged
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-500">
      Min Max Score
      <input class="<%= input_class %>" name="min_score" value="<%= @filters[:min_score].to_s %>">
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-500">
      Device (id/ip/name)
      <input class="<%= input_class %>" name="device" value="<%= @filters[:device].to_s %>">
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-500">
      Code
      <input class="<%= input_class %>" name="code" value="<%= @filters[:code].to_s %>">
    </label>
    <label class="flex flex-col gap-1 text-xs uppercase tracking-wider text-zinc-500">
      Window
      <select class="<%= input_class %>" name="window">
        <option value="" <%= "selected" if @filters[:window].to_s.empty? %>>All</option>
        <option value="1h" <%= "selected" if @filters[:window] == "1h" %>>1h</option>
        <option value="24h" <%= "selected" if @filters[:window] == "24h" %>>24h</option>
        <option value="7d" <%= "selected" if @filters[:window] == "7d" %>>7d</option>
      </select>
    </label>
    <div class="flex flex-wrap items-center gap-2 ml-auto">
      <button type="submit" class="<%= button_primary %>">Apply</button>
      <a href="/incidents" class="<%= button_neutral %>">Clear</a>
    </div>
  <% end %>
</form>

<%= render "shared/table" do %>
  <thead class="bg-zinc-950 text-zinc-400 text-xs uppercase tracking-wider">
    <tr>
      <th class="px-2 py-1.5 text-left">Last Seen</th>
      <th class="px-2 py-1.5 text-left">Device</th>
      <th class="px-2 py-1.5 text-left">Dst</th>
      <th class="px-2 py-1.5 text-left">Max Score</th>
      <th class="px-2 py-1.5 text-left">Codes</th>
      <th class="px-2 py-1.5 text-left">Count</th>
      <th class="px-2 py-1.5 text-left">Ack</th>
    </tr>
  </thead>
  <tbody>
    <% @incidents.each do |incident| %>
      <% device = @devices_by_id[incident.device_id] %>
      <% score = incident.max_score.to_i %>
      <% score_badge = score >= 70 ? "alert" : (score >= 50 ? "warn" : (score >= 20 ? "info" : "neutral")) %>
      <tr class="odd:bg-black even:bg-zinc-950/30 hover:bg-zinc-900/50">
        <td class="px-2 py-1.5"><a href="/incidents/<%= incident.id %>"><%= incident.last_seen_at %></a></td>
        <td class="px-2 py-1.5"><%= device&.name.presence || device&.ip %></td>
        <td class="px-2 py-1.5">
          <% if incident.dst_ip.present? %>
            <a href="/remote_hosts/<%= incident.dst_ip %>"><%= incident.dst_ip %></a><%= incident.dst_port ? ":#{incident.dst_port}" : "" %>
          <% end %>
        </td>
        <td class="px-2 py-1.5"><%= render "shared/badge", text: score, variant: score_badge %></td>
        <td class="px-2 py-1.5 max-w-[260px] truncate" title="<%= incident.codes_csv %>"><%= incident.codes_csv %></td>
        <td class="px-2 py-1.5"><%= incident.count %></td>
        <td class="px-2 py-1.5">
          <% if incident.acknowledged_at %>
            <%= render "shared/badge", text: "Acked", variant: "neutral" %>
          <% else %>
            <%= form_with url: "/incidents/#{incident.id}/ack", method: :post, local: true do |form| %>
              <div class="flex items-center gap-2">
                <%= form.text_field :ack_notes, name: "incident[ack_notes]", placeholder: "Notes", class: input_class %>
                <%= form.submit "Ack", class: button_primary %>
              </div>
            <% end %>
          <% end %>
        </td>
      </tr>
      <% hits = Array(@incident_hits[incident.id]).first(5) %>
      <% if hits.any? %>
        <tr class="bg-black/40">
          <td colspan="7" class="px-2 py-2">
            <details>
              <summary class="text-cyan-200 cursor-pointer">Recent hits (<%= hits.size %>)</summary>
              <ul class="mt-2 space-y-1 text-sm text-zinc-300">
                <% hits.each do |hit| %>
                  <li>
                    <%= hit.occurred_at %> â€”
                    <% if hit.dst_ip.present? %>
                      <a href="/remote_hosts/<%= hit.dst_ip %>"><%= hit.dst_ip %></a><%= hit.dst_port ? ":#{hit.dst_port}" : "" %>
                    <% end %>
                    (<%= hit.score %>) <%= hit.summary %>
                  </li>
                <% end %>
              </ul>
            </details>
          </td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
<% end %>

<div class="flex items-center gap-3 mt-3">
  <% if @page > 1 %>
    <a class="<%= button_neutral %>" href="/incidents?<%= request.query_parameters.merge(page: @page - 1).to_query %>">Prev</a>
  <% end %>
  <% if @page < @total_pages %>
    <a class="<%= button_neutral %>" href="/incidents?<%= request.query_parameters.merge(page: @page + 1).to_query %>">Next</a>
  <% end %>
</div>
