<h1>Incidents</h1>

<form class="netmon-filters" method="get">
  <label>
    Unacknowledged
    <input type="checkbox" name="unacknowledged" value="true" <%= "checked" if @filters[:unacknowledged].to_s == "true" %>>
  </label>
  <label>
    Min Max Score
    <input name="min_score" value="<%= @filters[:min_score].to_s %>">
  </label>
  <label>
    Device (id/ip/name)
    <input name="device" value="<%= @filters[:device].to_s %>">
  </label>
  <label>
    Code
    <input name="code" value="<%= @filters[:code].to_s %>">
  </label>
  <label>
    Window
    <select name="window">
      <option value="" <%= "selected" if @filters[:window].to_s.empty? %>>All</option>
      <option value="1h" <%= "selected" if @filters[:window] == "1h" %>>1h</option>
      <option value="24h" <%= "selected" if @filters[:window] == "24h" %>>24h</option>
      <option value="7d" <%= "selected" if @filters[:window] == "7d" %>>7d</option>
    </select>
  </label>
  <button type="submit">Apply</button>
  <a href="/incidents">Clear</a>
</form>

<table class="netmon-table">
  <thead>
    <tr>
      <th>Last Seen</th>
      <th>Device</th>
      <th>Dst</th>
      <th>Max Score</th>
      <th>Codes</th>
      <th>Count</th>
      <th>Ack</th>
    </tr>
  </thead>
  <tbody>
    <% @incidents.each do |incident| %>
      <% device = @devices_by_id[incident.device_id] %>
      <tr>
        <td><a href="/incidents/<%= incident.id %>"><%= incident.last_seen_at %></a></td>
        <td><%= device&.name.presence || device&.ip %></td>
        <td>
          <% if incident.dst_ip.present? %>
            <a href="/remote_hosts/<%= incident.dst_ip %>"><%= incident.dst_ip %></a><%= incident.dst_port ? ":#{incident.dst_port}" : "" %>
          <% end %>
        </td>
        <td><%= incident.max_score %></td>
        <td><%= incident.codes_csv %></td>
        <td><%= incident.count %></td>
        <td>
          <% if incident.acknowledged_at %>
            <%= incident.acknowledged_at %>
          <% else %>
            <%= form_with url: "/incidents/#{incident.id}/ack", method: :post, local: true do |form| %>
              <%= form.text_field :ack_notes, name: "incident[ack_notes]", placeholder: "Notes" %>
              <%= form.submit "Ack" %>
            <% end %>
          <% end %>
        </td>
      </tr>
      <% hits = Array(@incident_hits[incident.id]).first(5) %>
      <% if hits.any? %>
        <tr>
          <td colspan="7">
            <details>
              <summary>Recent hits (<%= hits.size %>)</summary>
              <ul>
                <% hits.each do |hit| %>
                  <li>
                    <%= hit.occurred_at %> â€”
                    <% if hit.dst_ip.present? %>
                      <a href="/remote_hosts/<%= hit.dst_ip %>"><%= hit.dst_ip %></a><%= hit.dst_port ? ":#{hit.dst_port}" : "" %>
                    <% end %>
                    (<%= hit.score %>) <%= hit.summary %>
                  </li>
                <% end %>
              </ul>
            </details>
          </td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<div class="netmon-pagination">
  <% if @page > 1 %>
    <a href="/incidents?<%= request.query_parameters.merge(page: @page - 1).to_query %>">Prev</a>
  <% end %>
  <% if @page < @total_pages %>
    <a href="/incidents?<%= request.query_parameters.merge(page: @page + 1).to_query %>">Next</a>
  <% end %>
</div>
