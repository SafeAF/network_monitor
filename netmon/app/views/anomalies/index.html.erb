<h1>Anomalies</h1>

<form class="netmon-filters" method="get">
  <label>
    Min Score
    <input name="min_score" value="<%= @filters[:min_score].to_s %>">
  </label>
  <label>
    Device (id/ip/name)
    <input name="device" value="<%= @filters[:device].to_s %>">
  </label>
  <label>
    Code
    <input name="code" value="<%= @filters[:code].to_s %>">
  </label>
  <label>
    Dst IP
    <input name="dst_ip" value="<%= @filters[:dst_ip].to_s %>">
  </label>
  <label>
    Dst Port
    <input name="dst_port" value="<%= @filters[:dst_port].to_s %>">
  </label>
  <label>
    Window
    <select name="window">
      <option value="" <%= "selected" if @filters[:window].to_s.empty? %>>All</option>
      <option value="1h" <%= "selected" if @filters[:window] == "1h" %>>1h</option>
      <option value="24h" <%= "selected" if @filters[:window] == "24h" %>>24h</option>
      <option value="7d" <%= "selected" if @filters[:window] == "7d" %>>7d</option>
    </select>
  </label>
  <button type="submit">Apply</button>
  <a href="/anomalies">Clear</a>
</form>

<table class="netmon-table">
  <thead>
    <tr>
      <th>Time</th>
      <th>Device</th>
      <th>Dst</th>
      <th>Proto</th>
      <th>Score</th>
      <th>Summary</th>
      <th>Reasons</th>
      <th>Ack</th>
    </tr>
  </thead>
  <tbody>
    <% @hits.each do |hit| %>
      <tr>
        <td><%= hit.occurred_at %></td>
        <td><%= hit.device&.name.presence || hit.device&.ip %></td>
        <td>
          <% if hit.dst_ip.present? %>
            <a href="/remote_hosts/<%= hit.dst_ip %>"><%= hit.dst_ip %></a><%= hit.dst_port ? ":#{hit.dst_port}" : "" %>
          <% end %>
        </td>
        <td><%= hit.proto %></td>
        <td><%= hit.score %></td>
        <td><%= hit.summary %></td>
        <td>
          <details>
            <summary><%= hit.reason_codes.join(",") %></summary>
            <pre><%= hit.reasons_json %></pre>
          </details>
        </td>
        <td>
          <% if hit.acknowledged_at %>
            <%= hit.acknowledged_at %>
          <% else %>
            <%= form_with model: hit, url: "/anomalies/#{hit.id}", method: :patch, local: true do |form| %>
              <%= form.text_field :ack_notes, placeholder: "Notes" %>
              <%= form.submit "Ack" %>
            <% end %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<div class="netmon-pagination">
  <% if @page > 1 %>
    <a href="/anomalies?<%= request.query_parameters.merge(page: @page - 1).to_query %>">Prev</a>
  <% end %>
  <% if @page < @total_pages %>
    <a href="/anomalies?<%= request.query_parameters.merge(page: @page + 1).to_query %>">Next</a>
  <% end %>
</div>
